<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ğŸ“˜ Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ | Luyangã®Blog</title>
<link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="/posts/linux-firmware-node-fwnode-%E7%BB%9F%E4%B8%80%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/">
  <meta property="og:site_name" content="Luyangã®Blog">
  <meta property="og:title" content="ğŸ“˜ Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹">
  <meta property="og:description" content="ğŸ“˜Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ 1. å¼•è¨€ Linux fwnodeï¼ˆFirmware Nodeï¼‰ç»Ÿä¸€è®¾å¤‡æ¨¡å‹æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºæŠ½è±¡ä¸åŒå›ºä»¶æè¿°æœºåˆ¶çš„é€šç”¨æ¡†æ¶ã€‚å®ƒä¸ºè®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰ã€ACPIï¼ˆAdvanced Configuration and Power Interfaceï¼‰ä»¥åŠå…¶ä»–å›ºä»¶æè¿°æ–¹å¼æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—é©±åŠ¨ç¨‹åºå¯ä»¥ä»¥ç›¸åŒçš„æ–¹å¼è®¿é—®è®¾å¤‡å±æ€§ä¿¡æ¯ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚çš„å›ºä»¶å®ç°ç»†èŠ‚ã€‚
2. å†å²èƒŒæ™¯ä¸å‘å±•å†ç¨‹ 2.1 æ—©æœŸå›ºä»¶æè¿°é—®é¢˜ åœ¨ fwnode æ¡†æ¶å‡ºç°ä¹‹å‰ï¼ŒLinux å†…æ ¸é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š
å¹³å°ä¾èµ–æ€§å¼ºï¼šARM å¹³å°ä¸»è¦ä½¿ç”¨ Device Treeï¼Œx86 å¹³å°ä½¿ç”¨ ACPI ä»£ç é‡å¤ï¼šé©±åŠ¨ç¨‹åºéœ€è¦ä¸ºä¸åŒå›ºä»¶æ ¼å¼ç¼–å†™é‡å¤çš„è§£æä»£ç  ç»´æŠ¤å›°éš¾ï¼šè·¨å¹³å°é©±åŠ¨ç»´æŠ¤æˆæœ¬é«˜ï¼Œå…¼å®¹æ€§é—®é¢˜é¢‘å‘ struct device *dev =...; int ret, irq; /* æ£€æŸ¥è®¾å¤‡æ˜¯å¦å…³è”äº†è®¾å¤‡æ ‘èŠ‚ç‚¹ */ if (dev-&gt;of_node) { /* å¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ of_* ç³»åˆ— API ä»è®¾å¤‡æ ‘ä¸­è¯»å–å±æ€§ */ ret = of_property_read_u32(dev-&gt;of_node, &#34;interrupts&#34;, &amp;irq); if (ret) { // é”™è¯¯å¤„ç† } } else if (ACPI_HANDLE(dev)) { /* å¦åˆ™ï¼Œæ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰å…³è”çš„ ACPI å¥æŸ„ */ /* ä½¿ç”¨ ACPI ç‰¹å®šçš„ API æ¥è§£æ _CRS (Current Resource Settings) */ /* è¿™é€šå¸¸æ¶‰åŠåˆ°ä¸€å¥—å¤æ‚ã€å†—é•¿çš„ ACPI èµ„æºè§£æé€»è¾‘ */ //... complex ACPI resource parsing logic... } else { /* å¯èƒ½è¿˜æœ‰åŸºäºå¹³å°æ•°æ®çš„ä¼ ç»Ÿç¡¬ç¼–ç æ–¹å¼ */ //... } 2.2 å‘å±•æ—¶é—´çº¿ Linux å†…æ ¸ç¤¾åŒºå¯¹ç»Ÿä¸€è®¾å¤‡æè¿°æ¥å£çš„æ¢ç´¢å§‹äº 2014 å¹´ï¼Œæ—¨åœ¨è§£å†³å¤šå›ºä»¶æ¥å£å¹¶å­˜å¸¦æ¥çš„æ¶æ„æ€§é—®é¢˜ã€‚fwnode æ¡†æ¶æ­£æ˜¯è¿™ä¸€æ¶æ„æ¼”è¿›çš„æ ¸å¿ƒæˆæœã€‚ä»¥ä¸‹æ˜¯è¯¥æ¡†æ¶çš„æ¼”è¿›æ—¶é—´çº¿å’Œå…³é”®èŠ‚ç‚¹ï¼š">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="1970-01-01T00:00:00+08:00">
    <meta property="article:modified_time" content="1970-01-01T00:00:00+08:00">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="ACPI">
    <meta property="article:tag" content="DTS">
    <meta property="article:tag" content="DeviceTree">
    <meta property="article:tag" content="Kernel">
    <meta property="article:tag" content="Firmware">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ğŸ“˜ Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹">
  <meta name="twitter:description" content="ğŸ“˜Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ 1. å¼•è¨€ Linux fwnodeï¼ˆFirmware Nodeï¼‰ç»Ÿä¸€è®¾å¤‡æ¨¡å‹æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºæŠ½è±¡ä¸åŒå›ºä»¶æè¿°æœºåˆ¶çš„é€šç”¨æ¡†æ¶ã€‚å®ƒä¸ºè®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰ã€ACPIï¼ˆAdvanced Configuration and Power Interfaceï¼‰ä»¥åŠå…¶ä»–å›ºä»¶æè¿°æ–¹å¼æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—é©±åŠ¨ç¨‹åºå¯ä»¥ä»¥ç›¸åŒçš„æ–¹å¼è®¿é—®è®¾å¤‡å±æ€§ä¿¡æ¯ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚çš„å›ºä»¶å®ç°ç»†èŠ‚ã€‚
2. å†å²èƒŒæ™¯ä¸å‘å±•å†ç¨‹ 2.1 æ—©æœŸå›ºä»¶æè¿°é—®é¢˜ åœ¨ fwnode æ¡†æ¶å‡ºç°ä¹‹å‰ï¼ŒLinux å†…æ ¸é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š
å¹³å°ä¾èµ–æ€§å¼ºï¼šARM å¹³å°ä¸»è¦ä½¿ç”¨ Device Treeï¼Œx86 å¹³å°ä½¿ç”¨ ACPI ä»£ç é‡å¤ï¼šé©±åŠ¨ç¨‹åºéœ€è¦ä¸ºä¸åŒå›ºä»¶æ ¼å¼ç¼–å†™é‡å¤çš„è§£æä»£ç  ç»´æŠ¤å›°éš¾ï¼šè·¨å¹³å°é©±åŠ¨ç»´æŠ¤æˆæœ¬é«˜ï¼Œå…¼å®¹æ€§é—®é¢˜é¢‘å‘ struct device *dev =...; int ret, irq; /* æ£€æŸ¥è®¾å¤‡æ˜¯å¦å…³è”äº†è®¾å¤‡æ ‘èŠ‚ç‚¹ */ if (dev-&gt;of_node) { /* å¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ of_* ç³»åˆ— API ä»è®¾å¤‡æ ‘ä¸­è¯»å–å±æ€§ */ ret = of_property_read_u32(dev-&gt;of_node, &#34;interrupts&#34;, &amp;irq); if (ret) { // é”™è¯¯å¤„ç† } } else if (ACPI_HANDLE(dev)) { /* å¦åˆ™ï¼Œæ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰å…³è”çš„ ACPI å¥æŸ„ */ /* ä½¿ç”¨ ACPI ç‰¹å®šçš„ API æ¥è§£æ _CRS (Current Resource Settings) */ /* è¿™é€šå¸¸æ¶‰åŠåˆ°ä¸€å¥—å¤æ‚ã€å†—é•¿çš„ ACPI èµ„æºè§£æé€»è¾‘ */ //... complex ACPI resource parsing logic... } else { /* å¯èƒ½è¿˜æœ‰åŸºäºå¹³å°æ•°æ®çš„ä¼ ç»Ÿç¡¬ç¼–ç æ–¹å¼ */ //... } 2.2 å‘å±•æ—¶é—´çº¿ Linux å†…æ ¸ç¤¾åŒºå¯¹ç»Ÿä¸€è®¾å¤‡æè¿°æ¥å£çš„æ¢ç´¢å§‹äº 2014 å¹´ï¼Œæ—¨åœ¨è§£å†³å¤šå›ºä»¶æ¥å£å¹¶å­˜å¸¦æ¥çš„æ¶æ„æ€§é—®é¢˜ã€‚fwnode æ¡†æ¶æ­£æ˜¯è¿™ä¸€æ¶æ„æ¼”è¿›çš„æ ¸å¿ƒæˆæœã€‚ä»¥ä¸‹æ˜¯è¯¥æ¡†æ¶çš„æ¼”è¿›æ—¶é—´çº¿å’Œå…³é”®èŠ‚ç‚¹ï¼š">

      <link rel="stylesheet" href="/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css" integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H&#43;ZeT/jBpieRZ8=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/bundle.min.d95a325399a05b50fe47dcf35b8229b8a2a014fcee5435cfb28204c6ac335fc5.css" integrity="sha256-2VoyU5mgW1D&#43;R9zzW4IpuKKgFPzuVDXPsoIExqwzX8U=" crossorigin="anonymous">

      <script src="/js/bundle.cc8ae9952dbfb731affafabdf26e5c60a6910047ff59ccdeaf1daebaa26c8830.js" integrity="sha256-zIrplS2/tzGv&#43;vq98m5cYKaRAEf/Wczerx2uuqJsiDA=" crossorigin="anonymous"></script><script defer src="/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js" integrity="sha256-ZFlLEl97eL30&#43;oMWlVkiu&#43;uxzWuu8/FmVL/KIDCfGPg="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="/" style="color: inherit;">Luyangã®Blog</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/features/"
      >Features</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/features/"
      >Features</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbspÂ»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="/posts/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbspÂ»&nbsp</span>
</ol>
<h1>ğŸ“˜ Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹</h1><time class="dim" datetime="1970-01-01T00:00:00&#43;08:00">January 1, 1970</time><div class="term-container"><div class="tag">
        <a href="/tags/linux/">#linux</a>
      </div><div class="tag">
        <a href="/tags/acpi/">#ACPI</a>
      </div><div class="tag">
        <a href="/tags/dts/">#DTS</a>
      </div><div class="tag">
        <a href="/tags/devicetree/">#DeviceTree</a>
      </div><div class="tag">
        <a href="/tags/kernel/">#kernel</a>
      </div><div class="tag">
        <a href="/tags/firmware/">#firmware</a>
      </div><div class="tag">
        <a href="/tags/fwnode/">#fwnode</a>
      </div></ol></div>
  <section class="page-section"><h1 id="linux-firmware-node-fwnode-ç»Ÿä¸€è®¾å¤‡æ¨¡å‹">ğŸ“˜Linux Firmware Node (fwnode) ç»Ÿä¸€è®¾å¤‡æ¨¡å‹</h1>
<h2 id="1-å¼•è¨€">1. å¼•è¨€</h2>
<p>Linux fwnodeï¼ˆFirmware Nodeï¼‰ç»Ÿä¸€è®¾å¤‡æ¨¡å‹æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºæŠ½è±¡ä¸åŒå›ºä»¶æè¿°æœºåˆ¶çš„é€šç”¨æ¡†æ¶ã€‚å®ƒä¸ºè®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰ã€ACPIï¼ˆAdvanced Configuration and Power Interfaceï¼‰ä»¥åŠå…¶ä»–å›ºä»¶æè¿°æ–¹å¼æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—é©±åŠ¨ç¨‹åºå¯ä»¥ä»¥ç›¸åŒçš„æ–¹å¼è®¿é—®è®¾å¤‡å±æ€§ä¿¡æ¯ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚çš„å›ºä»¶å®ç°ç»†èŠ‚ã€‚</p>
<h2 id="2-å†å²èƒŒæ™¯ä¸å‘å±•å†ç¨‹">2. å†å²èƒŒæ™¯ä¸å‘å±•å†ç¨‹</h2>
<h3 id="21-æ—©æœŸå›ºä»¶æè¿°é—®é¢˜">2.1 æ—©æœŸå›ºä»¶æè¿°é—®é¢˜</h3>
<p>åœ¨ fwnode æ¡†æ¶å‡ºç°ä¹‹å‰ï¼ŒLinux å†…æ ¸é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š</p>
<ul>
<li><strong>å¹³å°ä¾èµ–æ€§å¼º</strong>ï¼šARM å¹³å°ä¸»è¦ä½¿ç”¨ Device Treeï¼Œx86 å¹³å°ä½¿ç”¨ ACPI</li>
<li><strong>ä»£ç é‡å¤</strong>ï¼šé©±åŠ¨ç¨‹åºéœ€è¦ä¸ºä¸åŒå›ºä»¶æ ¼å¼ç¼–å†™é‡å¤çš„è§£æä»£ç </li>
<li><strong>ç»´æŠ¤å›°éš¾</strong>ï¼šè·¨å¹³å°é©±åŠ¨ç»´æŠ¤æˆæœ¬é«˜ï¼Œå…¼å®¹æ€§é—®é¢˜é¢‘å‘</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev <span style="color:#f92672">=</span>...;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> ret, irq;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* æ£€æŸ¥è®¾å¤‡æ˜¯å¦å…³è”äº†è®¾å¤‡æ ‘èŠ‚ç‚¹ */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (dev<span style="color:#f92672">-&gt;</span>of_node) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ of_* ç³»åˆ— API ä»è®¾å¤‡æ ‘ä¸­è¯»å–å±æ€§ */</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">of_property_read_u32</span>(dev<span style="color:#f92672">-&gt;</span>of_node, <span style="color:#e6db74">&#34;interrupts&#34;</span>, <span style="color:#f92672">&amp;</span>irq);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ret) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é”™è¯¯å¤„ç†
</span></span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ACPI_HANDLE</span>(dev)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å¦åˆ™ï¼Œæ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰å…³è”çš„ ACPI å¥æŸ„ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ä½¿ç”¨ ACPI ç‰¹å®šçš„ API æ¥è§£æ _CRS (Current Resource Settings) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è¿™é€šå¸¸æ¶‰åŠåˆ°ä¸€å¥—å¤æ‚ã€å†—é•¿çš„ ACPI èµ„æºè§£æé€»è¾‘ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//... complex ACPI resource parsing logic...
</span></span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å¯èƒ½è¿˜æœ‰åŸºäºå¹³å°æ•°æ®çš„ä¼ ç»Ÿç¡¬ç¼–ç æ–¹å¼ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="22-å‘å±•æ—¶é—´çº¿">2.2 å‘å±•æ—¶é—´çº¿</h3>
<p>Linux å†…æ ¸ç¤¾åŒºå¯¹ç»Ÿä¸€è®¾å¤‡æè¿°æ¥å£çš„æ¢ç´¢å§‹äº 2014 å¹´ï¼Œæ—¨åœ¨è§£å†³å¤šå›ºä»¶æ¥å£å¹¶å­˜å¸¦æ¥çš„æ¶æ„æ€§é—®é¢˜ã€‚fwnode æ¡†æ¶æ­£æ˜¯è¿™ä¸€æ¶æ„æ¼”è¿›çš„æ ¸å¿ƒæˆæœã€‚ä»¥ä¸‹æ˜¯è¯¥æ¡†æ¶çš„æ¼”è¿›æ—¶é—´çº¿å’Œå…³é”®èŠ‚ç‚¹ï¼š</p>
<h3 id="21-æ—¶é—´çº¿ä¸é‡Œç¨‹ç¢‘">2.1 æ—¶é—´çº¿ä¸é‡Œç¨‹ç¢‘</h3>
<table>
  <thead>
      <tr>
          <th>æ—¶é—´</th>
          <th>é‡Œç¨‹ç¢‘</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>2014</strong></td>
          <td>æ¦‚å¿µæå‡º</td>
          <td>å†…æ ¸æ ¸å¿ƒå¼€å‘è€… <strong>Rafael J. Wysocki</strong> é¦–æ¬¡æå‡º â€œç»Ÿä¸€å›ºä»¶æè¿°æ¥å£â€ æ¦‚å¿µï¼Œç›®æ ‡æ˜¯æŠ½è±¡ DT ä¸ ACPI çš„å¼‚æ„æ€§</td>
      </tr>
      <tr>
          <td><strong>2015</strong></td>
          <td>åˆå§‹å®ç°</td>
          <td><code>fwnode_handle</code> å’ŒåŸºæœ¬çš„æŠ½è±¡æ¡†æ¶é¦–æ¬¡è¢«åˆå…¥å†…æ ¸ä¸»çº¿ï¼ˆ4.x å¼€å§‹ï¼‰</td>
      </tr>
      <tr>
          <td><strong>2016</strong></td>
          <td>æ”¯æŒ ACPI</td>
          <td>fwnode å¼€å§‹å…¨é¢æ”¯æŒåŸºäº ACPI çš„è®¾å¤‡æè¿°ä¸èŠ‚ç‚¹ç»‘å®šï¼Œå®ç°ä¸è®¾å¤‡æ ‘ç­‰ä»·çš„æŠ½è±¡è®¿é—®</td>
      </tr>
      <tr>
          <td><strong>2017â€“2019</strong></td>
          <td>é«˜çº§åŠŸèƒ½æ‰©å±•</td>
          <td>æ·»åŠ æ”¯æŒå›¾å½¢åŒ–æ‹“æ‰‘ï¼ˆgraph nodesï¼‰ã€è½¯ä»¶èŠ‚ç‚¹ï¼ˆswnodeï¼‰ã€å¼•ç”¨è®¡æ•°ã€è·¯å¾„è§£æç­‰é«˜çº§èƒ½åŠ›</td>
      </tr>
      <tr>
          <td><strong>2020â€“ç°åœ¨</strong></td>
          <td>æŒç»­ä¼˜åŒ–ä¸åº”ç”¨æ‹“å±•</td>
          <td>åœ¨æ€§èƒ½ã€å¯ç»´æŠ¤æ€§å’Œå®‰å…¨æ€§æ–¹é¢ä¸æ–­æ”¹è¿›ï¼Œå¹¿æ³›åº”ç”¨äº I2Cã€SPIã€GPIOã€USBã€MIPIã€PCI ç­‰é€šç”¨è®¾å¤‡é©±åŠ¨</td>
      </tr>
  </tbody>
</table>
<h3 id="22-æ¨åŠ¨è€…ä¸ç»´æŠ¤è€…">2.2 æ¨åŠ¨è€…ä¸ç»´æŠ¤è€…</h3>
<p>fwnode çš„è®¾è®¡å’Œæ¨è¿›ç”±å†…æ ¸ç”µæºç®¡ç†å­ç³»ç»Ÿçš„æ ¸å¿ƒç»´æŠ¤è€… <strong>Rafael J. Wysocki</strong> ä¸»å¯¼ï¼Œå…¶ä»–å¦‚ <strong>Andy Shevchenko</strong>ã€<strong>Greg Kroah-Hartman</strong> ç­‰å¼€å‘è€…ä¹Ÿä¸ºå…¶åœ¨è®¾å¤‡æ¨¡å‹ä¸­çš„é›†æˆå’Œæ‰©å±•æä¾›äº†å¤§é‡è´¡çŒ®ã€‚</p>
<p>ç›¸å…³å­ç³»ç»Ÿæ¶‰åŠï¼š</p>
<ul>
<li><code>drivers/base</code>ï¼ˆæ ¸å¿ƒé©±åŠ¨æ¨¡å‹ï¼‰</li>
<li><code>drivers/of</code>ï¼ˆè®¾å¤‡æ ‘é€‚é…å±‚ï¼‰</li>
<li><code>drivers/acpi</code>ï¼ˆACPI å±‚å°è£…ï¼‰</li>
<li><code>drivers/base/swnode.c</code>ï¼ˆè½¯ä»¶èŠ‚ç‚¹æ”¯æŒï¼‰</li>
<li><code>include/linux/fwnode.h</code>ï¼ˆæ ¸å¿ƒ API å®šä¹‰ï¼‰</li>
</ul>
<h3 id="23-åº”ç”¨èŒƒå›´ä¸å½±å“åŠ›">2.3 åº”ç”¨èŒƒå›´ä¸å½±å“åŠ›</h3>
<p>fwnode æ¡†æ¶çš„å¼•å…¥ï¼Œæå¤§åœ°æå‡äº†é©±åŠ¨çš„è·¨å¹³å°å…¼å®¹æ€§å’Œå¼€å‘æ•ˆç‡ã€‚å®ƒå·²ç»æˆä¸º Linux å†…æ ¸ä¸­ä¸­å¤§å‹è®¾å¤‡é©±åŠ¨çš„æ ‡å‡†æ¶æ„ç»„ä»¶ï¼š</p>
<ul>
<li>
<p>âœ… <strong>å·²è¿ç§»å­ç³»ç»Ÿç¤ºä¾‹ï¼š</strong></p>
<ul>
<li>SPI æ§åˆ¶å™¨ï¼ˆå¦‚ DesignWare SPIã€Mediatek SPIï¼‰</li>
<li>I2C æ§åˆ¶å™¨</li>
<li>GPIO å­ç³»ç»Ÿ</li>
<li>USB Host/Device æ§åˆ¶å™¨</li>
<li>CSI/MIPI æ‘„åƒå¤´æ¥å£</li>
<li>PCI host bridge åˆå§‹åŒ–ä»£ç </li>
<li>å¤šåª’ä½“å­ç³»ç»Ÿä¸­çš„ graph-based æè¿°ï¼ˆå¦‚ HDMIã€DSIã€V4L2ï¼‰</li>
</ul>
</li>
<li>
<p>âœ… <strong>å…¸å‹ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>åŒä¸€é©±åŠ¨æ— éœ€åˆ¤æ–­ <code>dev-&gt;of_node</code> è¿˜æ˜¯ <code>ACPI_HANDLE()</code>ï¼Œç›´æ¥ä½¿ç”¨ <code>dev_fwnode()</code> å³å¯ç»Ÿä¸€è®¿é—®è®¾å¤‡ä¿¡æ¯</li>
<li>æ”¯æŒ DT/ACPI/SWNode æ— ç¼é›†æˆï¼Œä¾¿äºå¹³å°ä»£ç æŠ½è±¡</li>
<li>ä½¿é©±åŠ¨ä»£ç æ›´å…·å¯æµ‹è¯•æ€§ä¸æ¨¡å—åŒ–èƒ½åŠ›</li>
</ul>
</li>
</ul>
<h3 id="24-å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹å†…æ ¸ç‰ˆæœ¬å‚è€ƒ">2.4 å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹ï¼ˆå†…æ ¸ç‰ˆæœ¬å‚è€ƒï¼‰</h3>
<table>
  <thead>
      <tr>
          <th>Linux ç‰ˆæœ¬</th>
          <th>æ¼”è¿›äº®ç‚¹</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>4.1â€“4.4</td>
          <td>åˆå§‹ <code>fwnode_handle</code> æ¡†æ¶å»ºç«‹</td>
      </tr>
      <tr>
          <td>4.5â€“4.9</td>
          <td>ACPI fwnode å°è£…å®Œå–„</td>
      </tr>
      <tr>
          <td>4.10â€“4.19</td>
          <td>å¼•å…¥ <code>swnode</code>ï¼Œæ”¯æŒè™šæ‹Ÿè®¾å¤‡</td>
      </tr>
      <tr>
          <td>5.0â€“5.4</td>
          <td>å›¾å½¢æ‹“æ‰‘ã€å¼•ç”¨è®¡æ•°å¢å¼ºï¼›<code>device_get_match_data()</code> æ¨å¹¿</td>
      </tr>
      <tr>
          <td>5.5â€“5.15+</td>
          <td>å¹¿æ³›æ¨å¹¿è‡³ I2C/SPI/USB é©±åŠ¨ä¸­ï¼Œé»˜è®¤é‡‡ç”¨ fwnode è®¿é—®</td>
      </tr>
  </tbody>
</table>
<h2 id="3-æ¶æ„è®¾è®¡">3. æ¶æ„è®¾è®¡</h2>
<h3 id="31-æ•´ä½“æ¶æ„">3.1 æ•´ä½“æ¶æ„</h3>
<pre tabindex="0"><code>    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Driver Layer      â”‚  â† é©±åŠ¨ç¨‹åºå±‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   fwnode APIs       â”‚  â† ç»Ÿä¸€ API å±‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ fwnode Operations   â”‚  â† æ“ä½œå‡½æ•°å±‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚   â”‚   â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â” â”‚ â”Œâ”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  DT   â”‚ â”‚ â”‚ ACPI  â”‚    â† å›ºä»¶å®ç°å±‚
    â”‚fwnode â”‚ â”‚ â”‚fwnode â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
        â”‚   Other   â”‚
        â”‚  fwnode   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id="32-æ ¸å¿ƒæ•°æ®ç»“æ„">3.2 æ ¸å¿ƒæ•°æ®ç»“æ„</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * struct fwnode_handle - firmware node handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @secondary: æŒ‡å‘æ¬¡è¦å›ºä»¶èŠ‚ç‚¹çš„æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @ops: æ“ä½œå‡½æ•°é›†åˆæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @dev: å…³è”çš„è®¾å¤‡æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>secondary;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_operations <span style="color:#f92672">*</span>ops;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> list_head suppliers;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> list_head consumers;
</span></span><span style="display:flex;"><span>    u8 flags;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="33-æ“ä½œå‡½æ•°æ¥å£">3.3 æ“ä½œå‡½æ•°æ¥å£</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * struct fwnode_operations - fwnode æ“ä½œå‡½æ•°é›†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_operations {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>get)(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>put)(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> (<span style="color:#f92672">*</span>device_is_available)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>device_get_match_data)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                         <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> (<span style="color:#f92672">*</span>property_present)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                             <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>propname);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>property_read_int_array)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                   <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>propname,
</span></span><span style="display:flex;"><span>                                   <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> elem_size, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>val,
</span></span><span style="display:flex;"><span>                                   <span style="color:#66d9ef">size_t</span> nval);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>property_read_string_array)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                      <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>propname, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>val,
</span></span><span style="display:flex;"><span>                                      <span style="color:#66d9ef">size_t</span> nval);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>get_name)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>get_name_prefix)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>get_parent)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>get_next_child_node)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                                 <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>child);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>get_named_child_node)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                                  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>get_reference_args)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                              <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>prop, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>nargs_prop,
</span></span><span style="display:flex;"><span>                              <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> nargs, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> index,
</span></span><span style="display:flex;"><span>                              <span style="color:#66d9ef">struct</span> fwnode_reference_args <span style="color:#f92672">*</span>args);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>graph_get_next_endpoint)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                                     <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>prev);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>graph_get_remote_endpoint)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>graph_get_port_parent)(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>graph_parse_endpoint)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">struct</span> fwnode_endpoint <span style="color:#f92672">*</span>endpoint);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>iomap)(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode, <span style="color:#66d9ef">int</span> index);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>irq_get)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> index);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>add_links)(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="4-æ ¸å¿ƒç»„ä»¶è¯¦è§£">4. æ ¸å¿ƒç»„ä»¶è¯¦è§£</h2>
<h3 id="41-fwnode_handle-ç»“æ„ä½“">4.1 fwnode_handle ç»“æ„ä½“</h3>
<p>fwnode_handle æ˜¯æ•´ä¸ªæ¡†æ¶çš„æ ¸å¿ƒï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå›ºä»¶èŠ‚ç‚¹çš„æŠ½è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ç¤ºä¾‹ï¼šè·å–å’Œé‡Šæ”¾ fwnode
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">fwnode_get</span>(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>fwnode)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> fwnode<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span>get <span style="color:#f92672">?</span> fwnode<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(fwnode) <span style="color:#f92672">:</span> fwnode;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fwnode_put</span>(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>fwnode)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fwnode<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span>put)
</span></span><span style="display:flex;"><span>        fwnode<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">put</span>(fwnode);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="42-è®¾å¤‡å±æ€§æ“ä½œ">4.2 è®¾å¤‡å±æ€§æ“ä½œ</h3>
<h4 id="421-å±æ€§å­˜åœ¨æ€§æ£€æŸ¥">4.2.1 å±æ€§å­˜åœ¨æ€§æ£€æŸ¥</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">fwnode_property_present</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                             <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>propname)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_call_bool_op</span>(fwnode, property_present, propname);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ret <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode<span style="color:#f92672">-&gt;</span>secondary))
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_call_bool_op</span>(fwnode<span style="color:#f92672">-&gt;</span>secondary, property_present, propname);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="422-æ•´æ•°å±æ€§è¯»å–">4.2.2 æ•´æ•°å±æ€§è¯»å–</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fwnode_property_read_u32_array</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                   <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>propname, u32 <span style="color:#f92672">*</span>val, <span style="color:#66d9ef">size_t</span> nval)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_call_int_op</span>(fwnode, property_read_int_array,
</span></span><span style="display:flex;"><span>                             propname, <span style="color:#66d9ef">sizeof</span>(u32), val, nval);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>EINVAL <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode<span style="color:#f92672">-&gt;</span>secondary))
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_call_int_op</span>(fwnode<span style="color:#f92672">-&gt;</span>secondary, property_read_int_array,
</span></span><span style="display:flex;"><span>                                 propname, <span style="color:#66d9ef">sizeof</span>(u32), val, nval);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="423-å­—ç¬¦ä¸²å±æ€§è¯»å–">4.2.3 å­—ç¬¦ä¸²å±æ€§è¯»å–</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fwnode_property_read_string_array</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                      <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>propname, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>val,
</span></span><span style="display:flex;"><span>                                      <span style="color:#66d9ef">size_t</span> nval)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_call_int_op</span>(fwnode, property_read_string_array,
</span></span><span style="display:flex;"><span>                             propname, val, nval);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>EINVAL <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode<span style="color:#f92672">-&gt;</span>secondary))
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_call_int_op</span>(fwnode<span style="color:#f92672">-&gt;</span>secondary, property_read_string_array,
</span></span><span style="display:flex;"><span>                                 propname, val, nval);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="43-èŠ‚ç‚¹éå†æ“ä½œ">4.3 èŠ‚ç‚¹éå†æ“ä½œ</h3>
<h4 id="431-å­èŠ‚ç‚¹éå†">4.3.1 å­èŠ‚ç‚¹éå†</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define fwnode_for_each_child_node(fwnode, child)                  \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    for (child = fwnode_get_next_child_node(fwnode, NULL); child; \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         child = fwnode_get_next_child_node(fwnode, child))
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">fwnode_get_next_child_node</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                                 <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>child)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fwnode_call_ptr_op</span>(fwnode, get_next_child_node, child);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="432-çˆ¶èŠ‚ç‚¹è·å–">4.3.2 çˆ¶èŠ‚ç‚¹è·å–</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">fwnode_get_parent</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fwnode_call_ptr_op</span>(fwnode, get_parent);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="44-å›¾å½¢èŠ‚ç‚¹æ”¯æŒ">4.4 å›¾å½¢èŠ‚ç‚¹æ”¯æŒ</h3>
<p>å›¾å½¢èŠ‚ç‚¹ç”¨äºæè¿°è®¾å¤‡é—´çš„è¿æ¥å…³ç³»ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šåª’ä½“å­ç³»ç»Ÿä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * struct fwnode_endpoint - ç«¯ç‚¹æè¿°ç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_endpoint {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> port;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> id;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>local_fwnode;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fwnode_graph_parse_endpoint</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">struct</span> fwnode_endpoint <span style="color:#f92672">*</span>endpoint)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(endpoint, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>endpoint));
</span></span><span style="display:flex;"><span>    endpoint<span style="color:#f92672">-&gt;</span>local_fwnode <span style="color:#f92672">=</span> fwnode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fwnode_call_int_op</span>(fwnode, graph_parse_endpoint, endpoint);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="5-å®ç°æœºåˆ¶">5. å®ç°æœºåˆ¶</h2>
<h3 id="51-device-tree-fwnode-å®ç°">5.1 Device Tree fwnode å®ç°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_operations of_fwnode_ops <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .get <span style="color:#f92672">=</span> of_fwnode_get,
</span></span><span style="display:flex;"><span>    .put <span style="color:#f92672">=</span> of_fwnode_put,
</span></span><span style="display:flex;"><span>    .device_is_available <span style="color:#f92672">=</span> of_fwnode_device_is_available,
</span></span><span style="display:flex;"><span>    .device_get_match_data <span style="color:#f92672">=</span> of_fwnode_device_get_match_data,
</span></span><span style="display:flex;"><span>    .property_present <span style="color:#f92672">=</span> of_fwnode_property_present,
</span></span><span style="display:flex;"><span>    .property_read_int_array <span style="color:#f92672">=</span> of_fwnode_property_read_int_array,
</span></span><span style="display:flex;"><span>    .property_read_string_array <span style="color:#f92672">=</span> of_fwnode_property_read_string_array,
</span></span><span style="display:flex;"><span>    .get_name <span style="color:#f92672">=</span> of_fwnode_get_name,
</span></span><span style="display:flex;"><span>    .get_name_prefix <span style="color:#f92672">=</span> of_fwnode_get_name_prefix,
</span></span><span style="display:flex;"><span>    .get_parent <span style="color:#f92672">=</span> of_fwnode_get_parent,
</span></span><span style="display:flex;"><span>    .get_next_child_node <span style="color:#f92672">=</span> of_fwnode_get_next_child_node,
</span></span><span style="display:flex;"><span>    .get_named_child_node <span style="color:#f92672">=</span> of_fwnode_get_named_child_node,
</span></span><span style="display:flex;"><span>    .get_reference_args <span style="color:#f92672">=</span> of_fwnode_get_reference_args,
</span></span><span style="display:flex;"><span>    .graph_get_next_endpoint <span style="color:#f92672">=</span> of_fwnode_graph_get_next_endpoint,
</span></span><span style="display:flex;"><span>    .graph_get_remote_endpoint <span style="color:#f92672">=</span> of_fwnode_graph_get_remote_endpoint,
</span></span><span style="display:flex;"><span>    .graph_get_port_parent <span style="color:#f92672">=</span> of_fwnode_graph_get_port_parent,
</span></span><span style="display:flex;"><span>    .graph_parse_endpoint <span style="color:#f92672">=</span> of_fwnode_graph_parse_endpoint,
</span></span><span style="display:flex;"><span>    .iomap <span style="color:#f92672">=</span> of_fwnode_iomap,
</span></span><span style="display:flex;"><span>    .irq_get <span style="color:#f92672">=</span> of_fwnode_irq_get,
</span></span><span style="display:flex;"><span>    .add_links <span style="color:#f92672">=</span> of_fwnode_add_links,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">of_fwnode_handle</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> device_node <span style="color:#f92672">*</span>node)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> node <span style="color:#f92672">?</span> <span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>fwnode : NULL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="52-acpi-fwnode-å®ç°">5.2 ACPI fwnode å®ç°</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_operations acpi_fwnode_ops <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .get <span style="color:#f92672">=</span> acpi_fwnode_get,
</span></span><span style="display:flex;"><span>    .put <span style="color:#f92672">=</span> acpi_fwnode_put,
</span></span><span style="display:flex;"><span>    .device_is_available <span style="color:#f92672">=</span> acpi_fwnode_device_is_available,
</span></span><span style="display:flex;"><span>    .device_get_match_data <span style="color:#f92672">=</span> acpi_fwnode_device_get_match_data,
</span></span><span style="display:flex;"><span>    .property_present <span style="color:#f92672">=</span> acpi_fwnode_property_present,
</span></span><span style="display:flex;"><span>    .property_read_int_array <span style="color:#f92672">=</span> acpi_fwnode_property_read_int_array,
</span></span><span style="display:flex;"><span>    .property_read_string_array <span style="color:#f92672">=</span> acpi_fwnode_property_read_string_array,
</span></span><span style="display:flex;"><span>    .get_name <span style="color:#f92672">=</span> acpi_fwnode_get_name,
</span></span><span style="display:flex;"><span>    .get_name_prefix <span style="color:#f92672">=</span> acpi_fwnode_get_name_prefix,
</span></span><span style="display:flex;"><span>    .get_parent <span style="color:#f92672">=</span> acpi_fwnode_get_parent,
</span></span><span style="display:flex;"><span>    .get_next_child_node <span style="color:#f92672">=</span> acpi_fwnode_get_next_child_node,
</span></span><span style="display:flex;"><span>    .get_named_child_node <span style="color:#f92672">=</span> acpi_fwnode_get_named_child_node,
</span></span><span style="display:flex;"><span>    .get_reference_args <span style="color:#f92672">=</span> acpi_fwnode_get_reference_args,
</span></span><span style="display:flex;"><span>    .graph_get_next_endpoint <span style="color:#f92672">=</span> acpi_fwnode_graph_get_next_endpoint,
</span></span><span style="display:flex;"><span>    .graph_get_remote_endpoint <span style="color:#f92672">=</span> acpi_fwnode_graph_get_remote_endpoint,
</span></span><span style="display:flex;"><span>    .graph_get_port_parent <span style="color:#f92672">=</span> acpi_fwnode_graph_get_port_parent,
</span></span><span style="display:flex;"><span>    .graph_parse_endpoint <span style="color:#f92672">=</span> acpi_fwnode_graph_parse_endpoint,
</span></span><span style="display:flex;"><span>    .iomap <span style="color:#f92672">=</span> acpi_fwnode_iomap,
</span></span><span style="display:flex;"><span>    .irq_get <span style="color:#f92672">=</span> acpi_fwnode_irq_get,
</span></span><span style="display:flex;"><span>    .add_links <span style="color:#f92672">=</span> acpi_fwnode_add_links,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="6-ä½¿ç”¨æµç¨‹">6. ä½¿ç”¨æµç¨‹</h2>
<h3 id="61-å…¸å‹ä½¿ç”¨æµç¨‹">6.1 å…¸å‹ä½¿ç”¨æµç¨‹</h3>
<pre tabindex="0"><code>1. è·å–è®¾å¤‡çš„ fwnode_handle
   â†“
2. æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨
   â†“
3. è¯»å–å±æ€§å€¼
   â†“
4. å¤„ç†å­èŠ‚ç‚¹ï¼ˆå¦‚éœ€è¦ï¼‰
   â†“
5. é‡Šæ”¾ fwnode å¼•ç”¨
</code></pre><h3 id="62-ä»£ç ç¤ºä¾‹">6.2 ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ç¤ºä¾‹é©±åŠ¨ç¨‹åºä½¿ç”¨ fwnode API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">example_driver_probe</span>(<span style="color:#66d9ef">struct</span> platform_device <span style="color:#f92672">*</span>pdev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pdev<span style="color:#f92672">-&gt;</span>dev;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode <span style="color:#f92672">=</span> <span style="color:#a6e22e">dev_fwnode</span>(dev);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>child;
</span></span><span style="display:flex;"><span>    u32 reg_value;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>clock_name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* æ£€æŸ¥å¿…è¦å±æ€§æ˜¯å¦å­˜åœ¨ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fwnode_property_present</span>(fwnode, <span style="color:#e6db74">&#34;reg&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dev_err</span>(dev, <span style="color:#e6db74">&#34;Missing &#39;reg&#39; property</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENODEV;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è¯»å–å¯„å­˜å™¨åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_property_read_u32</span>(fwnode, <span style="color:#e6db74">&#34;reg&#34;</span>, <span style="color:#f92672">&amp;</span>reg_value);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ret) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dev_err</span>(dev, <span style="color:#e6db74">&#34;Failed to read &#39;reg&#39; property: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ret);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è¯»å–æ—¶é’Ÿåç§° */</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_property_read_string</span>(fwnode, <span style="color:#e6db74">&#34;clock-names&#34;</span>, <span style="color:#f92672">&amp;</span>clock_name);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ret)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dev_info</span>(dev, <span style="color:#e6db74">&#34;Using clock: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, clock_name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* éå†å­èŠ‚ç‚¹ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwnode_for_each_child_node</span>(fwnode, child) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>child_name;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_property_read_string</span>(child, <span style="color:#e6db74">&#34;label&#34;</span>, <span style="color:#f92672">&amp;</span>child_name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ret)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">dev_info</span>(dev, <span style="color:#e6db74">&#34;Found child: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, child_name);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="7-é«˜çº§åŠŸèƒ½">7. é«˜çº§åŠŸèƒ½</h2>
<h3 id="71-å¼•ç”¨è®¡æ•°ç®¡ç†">7.1 å¼•ç”¨è®¡æ•°ç®¡ç†</h3>
<p>fwnode æ¡†æ¶å®ç°äº†è‡ªåŠ¨å¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œç¡®ä¿èŠ‚ç‚¹åœ¨ä½¿ç”¨æœŸé—´ä¸ä¼šè¢«é‡Šæ”¾ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">fwnode_handle_get</span>(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fwnode_get</span>(fwnode);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fwnode_handle_put</span>(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwnode_put</span>(fwnode);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="72-è®¾å¤‡é“¾æ¥ç®¡ç†">7.2 è®¾å¤‡é“¾æ¥ç®¡ç†</h3>
<p>fwnode æ”¯æŒè®¾å¤‡é—´ä¾èµ–å…³ç³»çš„è‡ªåŠ¨ç®¡ç†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fwnode_link_add</span>(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>con, <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>sup)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_link <span style="color:#f92672">*</span>link;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mutex_lock</span>(<span style="color:#f92672">&amp;</span>fwnode_link_lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list_for_each_entry</span>(link, <span style="color:#f92672">&amp;</span>sup<span style="color:#f92672">-&gt;</span>suppliers, s_hook)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (link<span style="color:#f92672">-&gt;</span>consumer <span style="color:#f92672">==</span> con)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    link <span style="color:#f92672">=</span> <span style="color:#a6e22e">kzalloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>link), GFP_KERNEL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>link) {
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    link<span style="color:#f92672">-&gt;</span>supplier <span style="color:#f92672">=</span> sup;
</span></span><span style="display:flex;"><span>    link<span style="color:#f92672">-&gt;</span>consumer <span style="color:#f92672">=</span> con;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list_add</span>(<span style="color:#f92672">&amp;</span>link<span style="color:#f92672">-&gt;</span>s_hook, <span style="color:#f92672">&amp;</span>sup<span style="color:#f92672">-&gt;</span>suppliers);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list_add</span>(<span style="color:#f92672">&amp;</span>link<span style="color:#f92672">-&gt;</span>c_hook, <span style="color:#f92672">&amp;</span>con<span style="color:#f92672">-&gt;</span>consumers);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>out:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mutex_unlock</span>(<span style="color:#f92672">&amp;</span>fwnode_link_lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="73-å›¾å½¢èŠ‚ç‚¹æ‰©å±•">7.3 å›¾å½¢èŠ‚ç‚¹æ‰©å±•</h3>
<p>æ”¯æŒå¤æ‚çš„è®¾å¤‡è¿æ¥å›¾æè¿°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">fwnode_graph_get_next_endpoint</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode,
</span></span><span style="display:flex;"><span>                                                     <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>prev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fwnode_call_ptr_op</span>(fwnode, graph_get_next_endpoint, prev);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span><span style="color:#a6e22e">fwnode_graph_get_remote_endpoint</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR_OR_NULL</span>(fwnode))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fwnode_call_ptr_op</span>(fwnode, graph_get_remote_endpoint);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="8-æœ€ä½³å®è·µ">8. æœ€ä½³å®è·µ</h2>
<h3 id="81-é©±åŠ¨ç¨‹åºè®¾è®¡åŸåˆ™">8.1 é©±åŠ¨ç¨‹åºè®¾è®¡åŸåˆ™</h3>
<ol>
<li>
<p><strong>ç»Ÿä¸€æ¥å£ä½¿ç”¨</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* æ¨èï¼šä½¿ç”¨ fwnode API */</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_property_read_u32</span>(<span style="color:#a6e22e">dev_fwnode</span>(dev), <span style="color:#e6db74">&#34;reg&#34;</span>, <span style="color:#f92672">&amp;</span>reg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨ç‰¹å®šå›ºä»¶ API */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ret = of_property_read_u32(dev-&gt;of_node, &#34;reg&#34;, &amp;reg);
</span></span></span></code></pre></div></li>
<li>
<p><strong>é”™è¯¯å¤„ç†</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>child;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwnode_for_each_child_node</span>(fwnode, child) {
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">process_child_node</span>(child);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ret) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fwnode_handle_put</span>(child);  <span style="color:#75715e">/* é‡è¦ï¼šé‡Šæ”¾å¼•ç”¨ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>èµ„æºæ¸…ç†</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">example_driver_cleanup</span>(<span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode <span style="color:#f92672">=</span> <span style="color:#a6e22e">dev_fwnode</span>(dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* fwnode æœ¬èº«ç”±è®¾å¤‡æ¡†æ¶ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨é‡Šæ”¾ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ä½†å­èŠ‚ç‚¹å¼•ç”¨éœ€è¦æ˜¾å¼é‡Šæ”¾ */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="82-æ€§èƒ½ä¼˜åŒ–å»ºè®®">8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3>
<ol>
<li>
<p><strong>ç¼“å­˜å¸¸ç”¨å±æ€§</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> example_data {
</span></span><span style="display:flex;"><span>    u32 cached_reg;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cached_name;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">example_cache_properties</span>(<span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev, <span style="color:#66d9ef">struct</span> example_data <span style="color:#f92672">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode <span style="color:#f92672">=</span> <span style="color:#a6e22e">dev_fwnode</span>(dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwnode_property_read_u32</span>(fwnode, <span style="color:#e6db74">&#34;reg&#34;</span>, <span style="color:#f92672">&amp;</span>data<span style="color:#f92672">-&gt;</span>cached_reg);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwnode_property_read_string</span>(fwnode, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#f92672">&amp;</span>data<span style="color:#f92672">-&gt;</span>cached_name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>é¿å…é‡å¤æŸ¥æ‰¾</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* ä¸æ¨èï¼šé‡å¤æŸ¥æ‰¾ */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fwnode_property_present</span>(fwnode, <span style="color:#e6db74">&#34;enable-gpios&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwnode_property_read_u32</span>(fwnode, <span style="color:#e6db74">&#34;enable-gpios&#34;</span>, <span style="color:#f92672">&amp;</span>gpio);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* æ¨èï¼šä¸€æ¬¡æ€§è¯»å–å¹¶æ£€æŸ¥è¿”å›å€¼ */</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_property_read_u32</span>(fwnode, <span style="color:#e6db74">&#34;enable-gpios&#34;</span>, <span style="color:#f92672">&amp;</span>gpio);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ret) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ä½¿ç”¨ gpio å€¼ */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="83-è°ƒè¯•æŠ€å·§">8.3 è°ƒè¯•æŠ€å·§</h3>
<ol>
<li>
<p><strong>å±æ€§æ£€æŸ¥</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">debug_print_properties</span>(<span style="color:#66d9ef">struct</span> device <span style="color:#f92672">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode <span style="color:#f92672">=</span> <span style="color:#a6e22e">dev_fwnode</span>(dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fwnode_property_present</span>(fwnode, <span style="color:#e6db74">&#34;reg&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dev_dbg</span>(dev, <span style="color:#e6db74">&#34;Has &#39;reg&#39; property</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fwnode_property_present</span>(fwnode, <span style="color:#e6db74">&#34;interrupts&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dev_dbg</span>(dev, <span style="color:#e6db74">&#34;Has &#39;interrupts&#39; property</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>èŠ‚ç‚¹å±‚æ¬¡ç»“æ„è°ƒè¯•</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">debug_print_node_hierarchy</span>(<span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>fwnode, <span style="color:#66d9ef">int</span> level)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fwnode_handle <span style="color:#f92672">*</span>child;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_get_name</span>(fwnode);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pr_debug</span>(<span style="color:#e6db74">&#34;%*s%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, level <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;&#34;</span>, name <span style="color:#f92672">?:</span> <span style="color:#e6db74">&#34;&lt;unnamed&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwnode_for_each_child_node</span>(fwnode, child) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">debug_print_node_hierarchy</span>(child, level <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h2 id="9-æ•…éšœæ’æŸ¥">9. æ•…éšœæ’æŸ¥</h2>
<h3 id="91-å¸¸è§é—®é¢˜">9.1 å¸¸è§é—®é¢˜</h3>
<ol>
<li>
<p><strong>å±æ€§ä¸å­˜åœ¨é”™è¯¯</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* é—®é¢˜ï¼šå‡è®¾å±æ€§å­˜åœ¨ */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwnode_property_read_u32</span>(fwnode, <span style="color:#e6db74">&#34;missing-prop&#34;</span>, <span style="color:#f92672">&amp;</span>value);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* è§£å†³ï¼šæ£€æŸ¥è¿”å›å€¼ */</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fwnode_property_read_u32</span>(fwnode, <span style="color:#e6db74">&#34;maybe-missing&#34;</span>, <span style="color:#f92672">&amp;</span>value);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>EINVAL)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dev_warn</span>(dev, <span style="color:#e6db74">&#34;Property &#39;maybe-missing&#39; not found, using default</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span></code></pre></div></li>
<li>
<p><strong>èŠ‚ç‚¹å¼•ç”¨æ³„æ¼</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* é—®é¢˜ï¼šå¿˜è®°é‡Šæ”¾å­èŠ‚ç‚¹å¼•ç”¨ */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwnode_for_each_child_node</span>(fwnode, child) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error_condition)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EFAULT;  <span style="color:#75715e">/* æ³„æ¼äº† child å¼•ç”¨ */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* è§£å†³ï¼šæ­£ç¡®é‡Šæ”¾å¼•ç”¨ */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwnode_for_each_child_node</span>(fwnode, child) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error_condition) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fwnode_handle_put</span>(child);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EFAULT;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="92-è°ƒè¯•å·¥å…·">9.2 è°ƒè¯•å·¥å…·</h3>
<ol>
<li>
<p><strong>å†…æ ¸è°ƒè¯•é€‰é¡¹</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å¯ç”¨è®¾å¤‡æ ‘è°ƒè¯•</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#ae81ff">1</span> &gt; /sys/kernel/debug/dynamic_debug/control
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;file drivers/of/* +p&#39;</span> &gt; /sys/kernel/debug/dynamic_debug/control
</span></span></code></pre></div></li>
<li>
<p><strong>sysfs æ¥å£</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è®¾å¤‡å›ºä»¶ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>cat /sys/devices/.../firmware_node/...
</span></span></code></pre></div></li>
</ol>
<h2 id="10-æœªæ¥å‘å±•">10. æœªæ¥å‘å±•</h2>
<h3 id="101-å‘å±•è¶‹åŠ¿">10.1 å‘å±•è¶‹åŠ¿</h3>
<ol>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šç»§ç»­ä¼˜åŒ–å±æ€§æŸ¥æ‰¾å’Œç¼“å­˜æœºåˆ¶</li>
<li><strong>åŠŸèƒ½æ‰©å±•</strong>ï¼šæ”¯æŒæ›´å¤šå›ºä»¶æ ¼å¼å’Œç‰¹æ€§</li>
<li><strong>å·¥å…·æ”¹è¿›</strong>ï¼šæ›´å¥½çš„è°ƒè¯•å’Œåˆ†æå·¥å…·</li>
</ol>
<h3 id="102-ç›¸å…³æŠ€æœ¯">10.2 ç›¸å…³æŠ€æœ¯</h3>
<ul>
<li><strong>è®¾å¤‡èµ„æºç®¡ç†</strong>ï¼šä¸ devres æ¡†æ¶çš„æ·±åº¦é›†æˆ</li>
<li><strong>ç”µæºç®¡ç†</strong>ï¼šä¸ PM æ¡†æ¶çš„åä½œä¼˜åŒ–</li>
<li><strong>çƒ­æ’æ‹”æ”¯æŒ</strong>ï¼šåŠ¨æ€è®¾å¤‡ç®¡ç†èƒ½åŠ›å¢å¼º</li>
</ul>
<h2 id="11-ç»“è®º">11. ç»“è®º</h2>
<p>Linux fwnode ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ä¸ºå†…æ ¸æä¾›äº†ä¸€å¥—ä¼˜é›…çš„å›ºä»¶æŠ½è±¡å±‚ï¼Œæœ‰æ•ˆè§£å†³äº†è·¨å¹³å°é©±åŠ¨å¼€å‘çš„å¤æ‚æ€§é—®é¢˜ã€‚é€šè¿‡æä¾›ç»Ÿä¸€çš„ API æ¥å£ï¼Œå®ƒç®€åŒ–äº†é©±åŠ¨ç¨‹åºçš„å¼€å‘å’Œç»´æŠ¤ï¼Œæé«˜äº†ä»£ç çš„å¯é‡ç”¨æ€§å’Œå¯ç§»æ¤æ€§ã€‚</p>
<p>éšç€ Linux å†…æ ¸çš„æŒç»­å‘å±•ï¼Œfwnode æ¡†æ¶å°†ç»§ç»­æ¼”è¿›ï¼Œä¸ºæ›´å¤šçš„ç¡¬ä»¶å¹³å°å’Œä½¿ç”¨åœºæ™¯æä¾›æ”¯æŒã€‚å¯¹äºå†…æ ¸å¼€å‘è€…è€Œè¨€ï¼Œæ·±å…¥ç†è§£å’Œæ­£ç¡®ä½¿ç”¨ fwnode API æ˜¯ç¼–å†™é«˜è´¨é‡ã€è·¨å¹³å°é©±åŠ¨ç¨‹åºçš„å…³é”®æŠ€èƒ½ã€‚</p>
<hr>
<h1 id="é™„å½•">é™„å½•</h1>
<ul>
<li>ç›¸å…³æºç è·¯å¾„ï¼š
<ul>
<li><code>drivers/base/property.c</code></li>
<li><code>drivers/of/property.c</code></li>
<li><code>drivers/acpi/property.c</code></li>
<li><code>include/linux/fwnode.h</code></li>
</ul>
</li>
<li>å®˜æ–¹æ–‡æ¡£ï¼š
<ul>
<li><code>Documentation/devicetree/bindings/</code></li>
<li><code>Documentation/driver-api/fwnode.rst</code></li>
</ul>
</li>
</ul>
</section></main>
        <footer id="main-footer"><div class="footer">
  <a href="#">Scroll to Top</a>
  <div class="footer-copyright">
    <div class="dim">Â© 2026 Lu Yang</div>
    <div>Made with â¤ï¸ and powered by <a href="https://github.com/math-queiroz/rusty-typewriter" target="_blank">Rusty Typewriter</a> theme for <a href="https://gohugo.io/" target="_blank">Hugo</a></div>
  </div>
</div>
</footer>
      </div><aside id="side-pane" class="side-sticky"><div class="side-details">
    <span>1505 words</span>
    <span>20 - 26 minutes read</span></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#1-å¼•è¨€">1. å¼•è¨€</a></li>
    <li><a href="#2-å†å²èƒŒæ™¯ä¸å‘å±•å†ç¨‹">2. å†å²èƒŒæ™¯ä¸å‘å±•å†ç¨‹</a>
      <ul>
        <li><a href="#21-æ—©æœŸå›ºä»¶æè¿°é—®é¢˜">2.1 æ—©æœŸå›ºä»¶æè¿°é—®é¢˜</a></li>
        <li><a href="#22-å‘å±•æ—¶é—´çº¿">2.2 å‘å±•æ—¶é—´çº¿</a></li>
        <li><a href="#21-æ—¶é—´çº¿ä¸é‡Œç¨‹ç¢‘">2.1 æ—¶é—´çº¿ä¸é‡Œç¨‹ç¢‘</a></li>
        <li><a href="#22-æ¨åŠ¨è€…ä¸ç»´æŠ¤è€…">2.2 æ¨åŠ¨è€…ä¸ç»´æŠ¤è€…</a></li>
        <li><a href="#23-åº”ç”¨èŒƒå›´ä¸å½±å“åŠ›">2.3 åº”ç”¨èŒƒå›´ä¸å½±å“åŠ›</a></li>
        <li><a href="#24-å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹å†…æ ¸ç‰ˆæœ¬å‚è€ƒ">2.4 å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹ï¼ˆå†…æ ¸ç‰ˆæœ¬å‚è€ƒï¼‰</a></li>
      </ul>
    </li>
    <li><a href="#3-æ¶æ„è®¾è®¡">3. æ¶æ„è®¾è®¡</a>
      <ul>
        <li><a href="#31-æ•´ä½“æ¶æ„">3.1 æ•´ä½“æ¶æ„</a></li>
        <li><a href="#32-æ ¸å¿ƒæ•°æ®ç»“æ„">3.2 æ ¸å¿ƒæ•°æ®ç»“æ„</a></li>
        <li><a href="#33-æ“ä½œå‡½æ•°æ¥å£">3.3 æ“ä½œå‡½æ•°æ¥å£</a></li>
      </ul>
    </li>
    <li><a href="#4-æ ¸å¿ƒç»„ä»¶è¯¦è§£">4. æ ¸å¿ƒç»„ä»¶è¯¦è§£</a>
      <ul>
        <li><a href="#41-fwnode_handle-ç»“æ„ä½“">4.1 fwnode_handle ç»“æ„ä½“</a></li>
        <li><a href="#42-è®¾å¤‡å±æ€§æ“ä½œ">4.2 è®¾å¤‡å±æ€§æ“ä½œ</a></li>
        <li><a href="#43-èŠ‚ç‚¹éå†æ“ä½œ">4.3 èŠ‚ç‚¹éå†æ“ä½œ</a></li>
        <li><a href="#44-å›¾å½¢èŠ‚ç‚¹æ”¯æŒ">4.4 å›¾å½¢èŠ‚ç‚¹æ”¯æŒ</a></li>
      </ul>
    </li>
    <li><a href="#5-å®ç°æœºåˆ¶">5. å®ç°æœºåˆ¶</a>
      <ul>
        <li><a href="#51-device-tree-fwnode-å®ç°">5.1 Device Tree fwnode å®ç°</a></li>
        <li><a href="#52-acpi-fwnode-å®ç°">5.2 ACPI fwnode å®ç°</a></li>
      </ul>
    </li>
    <li><a href="#6-ä½¿ç”¨æµç¨‹">6. ä½¿ç”¨æµç¨‹</a>
      <ul>
        <li><a href="#61-å…¸å‹ä½¿ç”¨æµç¨‹">6.1 å…¸å‹ä½¿ç”¨æµç¨‹</a></li>
        <li><a href="#62-ä»£ç ç¤ºä¾‹">6.2 ä»£ç ç¤ºä¾‹</a></li>
      </ul>
    </li>
    <li><a href="#7-é«˜çº§åŠŸèƒ½">7. é«˜çº§åŠŸèƒ½</a>
      <ul>
        <li><a href="#71-å¼•ç”¨è®¡æ•°ç®¡ç†">7.1 å¼•ç”¨è®¡æ•°ç®¡ç†</a></li>
        <li><a href="#72-è®¾å¤‡é“¾æ¥ç®¡ç†">7.2 è®¾å¤‡é“¾æ¥ç®¡ç†</a></li>
        <li><a href="#73-å›¾å½¢èŠ‚ç‚¹æ‰©å±•">7.3 å›¾å½¢èŠ‚ç‚¹æ‰©å±•</a></li>
      </ul>
    </li>
    <li><a href="#8-æœ€ä½³å®è·µ">8. æœ€ä½³å®è·µ</a>
      <ul>
        <li><a href="#81-é©±åŠ¨ç¨‹åºè®¾è®¡åŸåˆ™">8.1 é©±åŠ¨ç¨‹åºè®¾è®¡åŸåˆ™</a></li>
        <li><a href="#82-æ€§èƒ½ä¼˜åŒ–å»ºè®®">8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®</a></li>
        <li><a href="#83-è°ƒè¯•æŠ€å·§">8.3 è°ƒè¯•æŠ€å·§</a></li>
      </ul>
    </li>
    <li><a href="#9-æ•…éšœæ’æŸ¥">9. æ•…éšœæ’æŸ¥</a>
      <ul>
        <li><a href="#91-å¸¸è§é—®é¢˜">9.1 å¸¸è§é—®é¢˜</a></li>
        <li><a href="#92-è°ƒè¯•å·¥å…·">9.2 è°ƒè¯•å·¥å…·</a></li>
      </ul>
    </li>
    <li><a href="#10-æœªæ¥å‘å±•">10. æœªæ¥å‘å±•</a>
      <ul>
        <li><a href="#101-å‘å±•è¶‹åŠ¿">10.1 å‘å±•è¶‹åŠ¿</a></li>
        <li><a href="#102-ç›¸å…³æŠ€æœ¯">10.2 ç›¸å…³æŠ€æœ¯</a></li>
      </ul>
    </li>
    <li><a href="#11-ç»“è®º">11. ç»“è®º</a></li>
  </ul>
</nav><h3>Related</h3>
    <ul><li><a href="/posts/vscode-%E9%98%85%E8%AF%BB-linux-%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AE/">vscode é˜…è¯» Linux å†…æ ¸ä»£ç é…ç½®</a></li><li><a href="/posts/linux_test_disk_i_o_with_dd/">Linux Test Disk with dd command</a></li><li><a href="/posts/virtualboxopensuse%E6%97%A0%E7%BD%91%E7%BB%9C%E5%9B%BE%E6%A0%87%E6%97%A0%E6%B3%95%E4%B8%8A%E7%BD%91/">Virtualbox Opensuse æ— ç½‘ç»œå›¾æ ‡ æ— æ³•ä¸Šç½‘</a></li><li><a href="/posts/samba/">samba</a></li><li><a href="/posts/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E6%89%80%E9%9C%80linux%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9/">ä¸€æ–‡ææ‡‚åº”ç”¨å¼€å‘æ‰€éœ€ Linux ç³»ç»Ÿæ—¶é—´çš„ç›¸å…³çŸ¥è¯†ç‚¹</a></li></ul></aside></div>
  </div>
</body>
</html>
