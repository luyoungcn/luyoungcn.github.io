<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Modern CMake 最佳实践：如何优雅地接管第三方子模块的 option 开关 | LuyangのBlog</title>
<link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="/posts/modern-cmake-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E6%8E%A5%E7%AE%A1%E7%AC%AC%E4%B8%89%E6%96%B9%E5%AD%90%E6%A8%A1%E5%9D%97%E7%9A%84-option-%E5%BC%80%E5%85%B3/">
  <meta property="og:site_name" content="LuyangのBlog">
  <meta property="og:title" content="Modern CMake 最佳实践：如何优雅地接管第三方子模块的 option 开关">
  <meta property="og:description" content="真实项目中遇到一个典型场景：第三方 SDK 默认打开了一个非常重的功能开关，导致全量构建时间暴涨 70%。记录一下用最 Modern 的方式彻底接管它的全过程。">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-10T00:00:00+00:00">
    <meta property="article:tag" content="Cmake">
    <meta property="article:tag" content="第三方模块管理">
    <meta property="article:tag" content="构建优化">
    <meta property="article:tag" content="CI加速">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Modern CMake 最佳实践：如何优雅地接管第三方子模块的 option 开关">
  <meta name="twitter:description" content="真实项目中遇到一个典型场景：第三方 SDK 默认打开了一个非常重的功能开关，导致全量构建时间暴涨 70%。记录一下用最 Modern 的方式彻底接管它的全过程。">

      <link rel="stylesheet" href="/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css" integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H&#43;ZeT/jBpieRZ8=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/bundle.min.d95a325399a05b50fe47dcf35b8229b8a2a014fcee5435cfb28204c6ac335fc5.css" integrity="sha256-2VoyU5mgW1D&#43;R9zzW4IpuKKgFPzuVDXPsoIExqwzX8U=" crossorigin="anonymous">

      <script src="/js/bundle.cc8ae9952dbfb731affafabdf26e5c60a6910047ff59ccdeaf1daebaa26c8830.js" integrity="sha256-zIrplS2/tzGv&#43;vq98m5cYKaRAEf/Wczerx2uuqJsiDA=" crossorigin="anonymous"></script><script defer src="/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js" integrity="sha256-ZFlLEl97eL30&#43;oMWlVkiu&#43;uxzWuu8/FmVL/KIDCfGPg="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="/" style="color: inherit;">LuyangのBlog</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/features/"
      >Features</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/features/"
      >Features</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbsp»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="/posts/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbsp»&nbsp</span>
</ol>
<h1>Modern CMake 最佳实践：如何优雅地接管第三方子模块的 option 开关</h1><time class="dim" datetime="2025-12-10T00:00:00&#43;00:00">December 10, 2025</time><div class="term-container"><div class="tag">
        <a href="/tags/cmake/">#cmake</a>
      </div><div class="tag">
        <a href="/tags/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97%E7%AE%A1%E7%90%86/">#第三方模块管理</a>
      </div><div class="tag">
        <a href="/tags/%E6%9E%84%E5%BB%BA%E4%BC%98%E5%8C%96/">#构建优化</a>
      </div><div class="tag">
        <a href="/tags/ci%E5%8A%A0%E9%80%9F/">#CI加速</a>
      </div></ol></div>
  <section class="page-section"><h2 id="起因一个永远关不掉的巨型开关">起因：一个“永远关不掉”的巨型开关</h2>
<p>最近在维护一个嵌入式多平台驱动仓库时，发现第三方提供的一个 SDK 子模块 默认打开了一个超级重的功能（编译时间从 9 分钟直接飙到 15 分钟+，产出体积也多出好几 MB）。</p>
<p>子模块里的写法非常“复古”：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>option(<span style="color:#e6db74">ENABLE_HEAVY_FEATURE</span> <span style="color:#e6db74">&#34;Enable very heavy legacy feature&#34;</span> <span style="color:#e6db74">ON</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if(<span style="color:#e6db74">ENABLE_HEAVY_FEATURE</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    add_definitions(<span style="color:#e6db74">-DHEAVY_FEATURE</span>)   <span style="color:#75715e"># 全局污染
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>而我们主项目 95% 的配置压根不需要这个功能，CI 每次都白白浪费大量时间。</p>
<h2 id="最-modern最推荐的接管方式2025-年写法">最 Modern、最推荐的接管方式（2025 年写法）</h2>
<p>在顶级项目（或统一放第三方开关的文件）里，<strong>在 add_subdirectory 之前</strong>写一行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># 第三方模块统一控制区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set(<span style="color:#e6db74">ENABLE_HEAVY_FEATURE</span> <span style="color:#e6db74">OFF</span> <span style="color:#e6db74">CACHE</span> <span style="color:#e6db74">BOOL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[VendorSDK] Enable heavy legacy feature (significantly increases build time and binary size)&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>然后正常添加子模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_subdirectory(<span style="color:#e6db74">external/vendor-sdk-v2.3.0</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>效果立竿见影：</p>
<ul>
<li>子模块里 <code>option()</code> 的默认值被彻底忽略</li>
<li>CMake GUI / ccmake / 命令行都能看到我们自己的描述</li>
<li>CI 想临时打开时只需要加 <code>-DENABLE_HEAVY_FEATURE=ON</code></li>
<li>再也没有全局宏污染</li>
</ul>
<h2 id="为什么必须用-set-cache-">为什么必须用 set(&hellip; CACHE &hellip;)？</h2>
<table>
  <thead>
      <tr>
          <th>写法</th>
          <th>是否推荐</th>
          <th>后果</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>父目录再次 <code>option(ENABLE_HEAVY_FEATURE ...)</code></td>
          <td>不推荐</td>
          <td>CMake 直接报错</td>
      </tr>
      <tr>
          <td>父目录 <code>set(ENABLE_HEAVY_FEATURE ON)</code>（无 CACHE）</td>
          <td>勉强可用</td>
          <td>普通变量会被子模块的 option() 重新变成缓存变量，行为混乱</td>
      </tr>
      <tr>
          <td>父目录 <code>set(... CACHE BOOL ...)</code></td>
          <td>强烈推荐</td>
          <td>完全接管默认值、描述、类型，最清晰</td>
      </tr>
      <tr>
          <td>只靠命令行 <code>-D</code></td>
          <td>推荐配合使用</td>
          <td>最灵活，适合 CI 多配置构建</td>
      </tr>
  </tbody>
</table>
<h2 id="我们现在的统一写法企业级项目标配">我们现在的统一写法（企业级项目标配）</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># cmake/options-thirdparty.cmake
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set(<span style="color:#e6db74">ENABLE_HEAVY_FEATURE</span>         <span style="color:#e6db74">OFF</span> <span style="color:#e6db74">CACHE</span> <span style="color:#e6db74">BOOL</span> <span style="color:#e6db74">&#34;[Vendor] Heavy legacy mode (+6 min build)&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">ENABLE_EXPERIMENTAL_MODULE</span>   <span style="color:#e6db74">ON</span>  <span style="color:#e6db74">CACHE</span> <span style="color:#e6db74">BOOL</span> <span style="color:#e6db74">&#34;[Vendor] Next-gen experimental driver&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">ENABLE_DEBUG_SYMBOLS</span>         <span style="color:#e6db74">OFF</span> <span style="color:#e6db74">CACHE</span> <span style="color:#e6db74">BOOL</span> <span style="color:#e6db74">&#34;[Vendor] Keep private debug symbols&#34;</span> <span style="color:#e6db74">OFF</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 所有 add_subdirectory 之前统一 include 一次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>include(<span style="color:#e6db74">cmake/options-thirdparty.cmake</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这样整个团队和所有 CI 看到的都是同一份干净的开关列表，再也不可能出现“我以为关了结果其实没关”的情况。</p>
<h2 id="小结">小结</h2>
<p>接管第三方子模块的 option，只需要记住最核心的一句话：</p>
<blockquote>
<p><strong>在 add_subdirectory 之前，用 <code>set(XXX xxx CACHE BOOL &quot;你的描述&quot;)</code> 强行设定即可。</strong></p>
</blockquote>
</section></main>
        <footer id="main-footer"><div class="footer">
  <a href="#">Scroll to Top</a>
  <div class="footer-copyright">
    <div class="dim">© 2025 Lu Yang</div>
    <div>Made with ❤️ and powered by <a href="https://github.com/math-queiroz/rusty-typewriter" target="_blank">Rusty Typewriter</a> theme for <a href="https://gohugo.io/" target="_blank">Hugo</a></div>
  </div>
</div>
</footer>
      </div><aside id="side-pane" class="side-sticky"><div class="side-details">
    <span>155 words</span>
    <span>2 - 3 minutes read</span></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#起因一个永远关不掉的巨型开关">起因：一个“永远关不掉”的巨型开关</a></li>
    <li><a href="#最-modern最推荐的接管方式2025-年写法">最 Modern、最推荐的接管方式（2025 年写法）</a></li>
    <li><a href="#为什么必须用-set-cache-">为什么必须用 set(&hellip; CACHE &hellip;)？</a></li>
    <li><a href="#我们现在的统一写法企业级项目标配">我们现在的统一写法（企业级项目标配）</a></li>
    <li><a href="#小结">小结</a></li>
  </ul>
</nav><h3>Related</h3>
    <ul><li><a href="/posts/cmake-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%98%B2%E5%BE%A1%E6%80%A7%E5%86%99%E6%B3%95/">CMake 缓存机制完全指南：从原理到企业级防御性写法</a></li><li><a href="/posts/%E5%91%8A%E5%88%AB%E5%85%A8%E5%B1%80%E6%B1%A1%E6%9F%93modern-cmake-%E7%9A%84%E7%9B%AE%E6%A0%87%E7%BA%A7%E9%9A%94%E7%A6%BB%E8%A7%84%E8%8C%83/">告别全局污染：Modern CMake 的目标级隔离规范</a></li></ul></aside></div>
  </div>
</body>
</html>
