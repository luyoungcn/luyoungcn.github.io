<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ğŸ“Œå°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC&#43;&#43;å®¹å™¨çš„æ€§èƒ½åˆ©å™¨ | Luyangã®Blog</title>
<link rel="icon" href="favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="/posts/%E5%B0%8F%E5%AF%B9%E8%B1%A1%E4%BC%98%E5%8C%96small-object-optimization%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90c&#43;&#43;%E5%AE%B9%E5%99%A8%E7%9A%84%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8/">
  <meta property="og:site_name" content="Luyangã®Blog">
  <meta property="og:title" content="ğŸ“Œå°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC&#43;&#43;å®¹å™¨çš„æ€§èƒ½åˆ©å™¨">
  <meta property="og:description" content="å°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC&#43;&#43;å®¹å™¨çš„æ€§èƒ½åˆ©å™¨ å¼•è¨€ åœ¨ç°ä»£C&#43;&#43;å¼€å‘ä¸­ï¼Œstd::stringå’Œstd::vectorç­‰æ ‡å‡†å®¹å™¨çš„é«˜æ•ˆæ€§å¾€å¾€è¢«å¼€å‘è€…è§†ä¸ºç†æ‰€å½“ç„¶ã€‚ç„¶è€Œï¼Œè¿™äº›å®¹å™¨åœ¨å¤„ç†å°å¯¹è±¡æ—¶çš„å“è¶Šæ€§èƒ½èƒŒåï¼Œéšè—ç€ä¸€é¡¹é‡è¦çš„ä¼˜åŒ–æŠ€æœ¯â€”â€”å°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimization, SOOï¼‰ã€‚å¯¹äºè¿½æ±‚é«˜æ€§èƒ½çš„C&#43;&#43;å¼€å‘è€…è€Œè¨€ï¼Œç†è§£SOOçš„å·¥ä½œåŸç†ä¸ä»…æœ‰åŠ©äºç¼–å†™æ›´é«˜æ•ˆçš„ä»£ç ï¼Œæ›´èƒ½å¯å‘æˆ‘ä»¬åœ¨è®¾è®¡è‡ªå®šä¹‰å®¹å™¨æ—¶é‡‡ç”¨ç±»ä¼¼çš„ä¼˜åŒ–ç­–ç•¥ã€‚
é—®é¢˜èƒŒæ™¯ï¼šå°å¯¹è±¡çš„æ€§èƒ½å›°å¢ƒ å †åˆ†é…çš„æ€§èƒ½å¼€é”€ å½“æˆ‘ä»¬ä½¿ç”¨std::stringæˆ–std::vectorå­˜å‚¨æ•°æ®æ—¶ï¼Œè¿™äº›å®¹å™¨é€šå¸¸éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜æ¥å­˜å‚¨å®é™…æ•°æ®ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼Œå †åˆ†é…çš„å¼€é”€ç›¸å¯¹äºæ•°æ®å¤„ç†æˆæœ¬è€Œè¨€æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬é¢‘ç¹å¤„ç†å°å¯¹è±¡æ—¶ï¼Œæƒ…å†µå°±æˆªç„¶ä¸åŒäº†ï¼š
åˆ†é…å™¨å¼€é”€ï¼šæ¯æ¬¡è°ƒç”¨new/deleteæˆ–malloc/freeéƒ½æ¶‰åŠå¤æ‚çš„å†…å­˜ç®¡ç†ç®—æ³•ï¼ŒåŒ…æ‹¬å¯»æ‰¾åˆé€‚å¤§å°çš„å†…å­˜å—ã€ç»´æŠ¤ç©ºé—²åˆ—è¡¨ç­‰ å†…å­˜ç¢ç‰‡ï¼šå¤§é‡å°å†…å­˜å—çš„åˆ†é…å’Œé‡Šæ”¾ä¼šå¯¼è‡´å †å†…å­˜ç¢ç‰‡åŒ–ï¼Œé™ä½å†…å­˜åˆ©ç”¨ç‡ ç¼“å­˜å±€éƒ¨æ€§å·®ï¼šå †ä¸Šåˆ†é…çš„å°å¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†å¸ƒæ•£ä¹±ï¼Œè®¿é—®æ—¶ç¼“å­˜å‘½ä¸­ç‡ä½ ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™ æ ˆä¸Šåˆ†é…è™½ç„¶é€Ÿåº¦æå¿«ï¼Œä½†å—é™äºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ— æ³•æ»¡è¶³å®¹å™¨éœ€è¦åŠ¨æ€è°ƒæ•´å¤§å°çš„éœ€æ±‚ã€‚è€Œçº¯ç²¹çš„å †åˆ†é…è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†çŸ­å­—ç¬¦ä¸²ã€å°å®¹é‡å‘é‡ç­‰é«˜é¢‘åœºæ™¯æ—¶ï¼Œæ€§èƒ½å¼€é”€å˜å¾—ä¸å¯å¿½è§†ã€‚
æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•ä¸ºéœ€è¦åŠ¨æ€å†…å­˜ç®¡ç†çš„å®¹å™¨ä¼˜åŒ–å°å¯¹è±¡çš„å­˜å‚¨æ€§èƒ½ï¼Ÿ
SOOæ ¸å¿ƒåŸç†ï¼šæ™ºèƒ½çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ åŸºæœ¬æ€æƒ³ å°å¯¹è±¡ä¼˜åŒ–çš„æ ¸å¿ƒç­–ç•¥æ˜¯åœ¨å®¹å™¨å¯¹è±¡å†…éƒ¨é¢„ç•™ä¸€ä¸ªå›ºå®šå¤§å°çš„å†…éƒ¨ç¼“å†²åŒºï¼ˆInternal Bufferï¼‰ã€‚è¿™ä¸ªç¼“å†²åŒºä½œä¸º&#34;å¿«é€Ÿé€šé“&#34;ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å°å¯¹è±¡çš„æ•°æ®ã€‚
å¤§å°åˆ¤å®šé€»è¾‘ SOOçš„å·¥ä½œæœºåˆ¶å¯ä»¥ç”¨ç®€å•çš„æ¡ä»¶åˆ¤æ–­æ¥æè¿°ï¼š
if (required_size &lt;= internal_buffer_size) { // ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºï¼Œæ— éœ€å †åˆ†é… store_in_internal_buffer(data); } else { // é€€å›åˆ°ä¼ ç»Ÿçš„å †å†…å­˜åˆ†é… allocate_on_heap(data); } Zero-OverheadæŠ½è±¡ SOOçš„ç²¾å¦™ä¹‹å¤„åœ¨äºå¯¹ä½¿ç”¨è€…å®Œå…¨é€æ˜ã€‚æ— è®ºåº•å±‚ä½¿ç”¨çš„æ˜¯å†…éƒ¨ç¼“å†²åŒºè¿˜æ˜¯å †å†…å­˜ï¼Œå®¹å™¨æä¾›çš„æ¥å£è¡Œä¸ºå®Œå…¨ä¸€è‡´ï¼Œè¿™ä½“ç°äº†C&#43;&#43;ä¸­&#34;Zero-Overhead&#34;æŠ½è±¡çš„è®¾è®¡ç†å¿µã€‚
å®ç°å‰–æï¼šä»¥std::stringä¸ºä¾‹ å…¸å‹æ•°æ®ç»“æ„è®¾è®¡ ä¸€ä¸ªæ”¯æŒSOOçš„std::stringå†…éƒ¨ç»“æ„å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š
class optimized_string { private: static constexpr size_t INTERNAL_BUFFER_SIZE = 15; union { // å¤§å¯¹è±¡æ¨¡å¼ï¼šæŒ‡å‘å †å†…å­˜ struct { char* ptr; size_t size; size_t capacity; } heap_data; // å°å¯¹è±¡æ¨¡å¼ï¼šç›´æ¥å­˜å‚¨åœ¨å¯¹è±¡å†…éƒ¨ struct { char buffer[INTERNAL_BUFFER_SIZE &#43; 1]; // &#43;1 for null terminator unsigned char remaining_size; // ç”¨äºæ ‡è¯†å½“å‰æ¨¡å¼å’Œå‰©ä½™ç©ºé—´ } stack_data; }; public: bool is_using_soo() const { // é€šè¿‡ç‰¹å®šä½æˆ–å€¼åˆ¤æ–­å½“å‰ä½¿ç”¨çš„å­˜å‚¨æ¨¡å¼ return stack_data.remaining_size &lt;= INTERNAL_BUFFER_SIZE; } const char* data() const { return is_using_soo() ? stack_data.buffer : heap_data.ptr; } size_t size() const { return is_using_soo() ? (INTERNAL_BUFFER_SIZE - stack_data.remaining_size) : heap_data.size; } }; çŠ¶æ€åŒºåˆ†æœºåˆ¶ åŒºåˆ†å½“å‰ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºè¿˜æ˜¯å †å†…å­˜æ˜¯SOOå®ç°çš„å…³é”®æŠ€æœ¯ç‚¹ã€‚å¸¸è§ç­–ç•¥åŒ…æ‹¬ï¼š">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-04T02:30:00+08:00">
    <meta property="article:modified_time" content="2025-06-04T02:30:00+08:00">
    <meta property="article:tag" content="Cpp">
    <meta property="article:tag" content="SOO">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ğŸ“Œå°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC&#43;&#43;å®¹å™¨çš„æ€§èƒ½åˆ©å™¨">
  <meta name="twitter:description" content="å°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC&#43;&#43;å®¹å™¨çš„æ€§èƒ½åˆ©å™¨ å¼•è¨€ åœ¨ç°ä»£C&#43;&#43;å¼€å‘ä¸­ï¼Œstd::stringå’Œstd::vectorç­‰æ ‡å‡†å®¹å™¨çš„é«˜æ•ˆæ€§å¾€å¾€è¢«å¼€å‘è€…è§†ä¸ºç†æ‰€å½“ç„¶ã€‚ç„¶è€Œï¼Œè¿™äº›å®¹å™¨åœ¨å¤„ç†å°å¯¹è±¡æ—¶çš„å“è¶Šæ€§èƒ½èƒŒåï¼Œéšè—ç€ä¸€é¡¹é‡è¦çš„ä¼˜åŒ–æŠ€æœ¯â€”â€”å°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimization, SOOï¼‰ã€‚å¯¹äºè¿½æ±‚é«˜æ€§èƒ½çš„C&#43;&#43;å¼€å‘è€…è€Œè¨€ï¼Œç†è§£SOOçš„å·¥ä½œåŸç†ä¸ä»…æœ‰åŠ©äºç¼–å†™æ›´é«˜æ•ˆçš„ä»£ç ï¼Œæ›´èƒ½å¯å‘æˆ‘ä»¬åœ¨è®¾è®¡è‡ªå®šä¹‰å®¹å™¨æ—¶é‡‡ç”¨ç±»ä¼¼çš„ä¼˜åŒ–ç­–ç•¥ã€‚
é—®é¢˜èƒŒæ™¯ï¼šå°å¯¹è±¡çš„æ€§èƒ½å›°å¢ƒ å †åˆ†é…çš„æ€§èƒ½å¼€é”€ å½“æˆ‘ä»¬ä½¿ç”¨std::stringæˆ–std::vectorå­˜å‚¨æ•°æ®æ—¶ï¼Œè¿™äº›å®¹å™¨é€šå¸¸éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜æ¥å­˜å‚¨å®é™…æ•°æ®ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼Œå †åˆ†é…çš„å¼€é”€ç›¸å¯¹äºæ•°æ®å¤„ç†æˆæœ¬è€Œè¨€æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬é¢‘ç¹å¤„ç†å°å¯¹è±¡æ—¶ï¼Œæƒ…å†µå°±æˆªç„¶ä¸åŒäº†ï¼š
åˆ†é…å™¨å¼€é”€ï¼šæ¯æ¬¡è°ƒç”¨new/deleteæˆ–malloc/freeéƒ½æ¶‰åŠå¤æ‚çš„å†…å­˜ç®¡ç†ç®—æ³•ï¼ŒåŒ…æ‹¬å¯»æ‰¾åˆé€‚å¤§å°çš„å†…å­˜å—ã€ç»´æŠ¤ç©ºé—²åˆ—è¡¨ç­‰ å†…å­˜ç¢ç‰‡ï¼šå¤§é‡å°å†…å­˜å—çš„åˆ†é…å’Œé‡Šæ”¾ä¼šå¯¼è‡´å †å†…å­˜ç¢ç‰‡åŒ–ï¼Œé™ä½å†…å­˜åˆ©ç”¨ç‡ ç¼“å­˜å±€éƒ¨æ€§å·®ï¼šå †ä¸Šåˆ†é…çš„å°å¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†å¸ƒæ•£ä¹±ï¼Œè®¿é—®æ—¶ç¼“å­˜å‘½ä¸­ç‡ä½ ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™ æ ˆä¸Šåˆ†é…è™½ç„¶é€Ÿåº¦æå¿«ï¼Œä½†å—é™äºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ— æ³•æ»¡è¶³å®¹å™¨éœ€è¦åŠ¨æ€è°ƒæ•´å¤§å°çš„éœ€æ±‚ã€‚è€Œçº¯ç²¹çš„å †åˆ†é…è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†çŸ­å­—ç¬¦ä¸²ã€å°å®¹é‡å‘é‡ç­‰é«˜é¢‘åœºæ™¯æ—¶ï¼Œæ€§èƒ½å¼€é”€å˜å¾—ä¸å¯å¿½è§†ã€‚
æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•ä¸ºéœ€è¦åŠ¨æ€å†…å­˜ç®¡ç†çš„å®¹å™¨ä¼˜åŒ–å°å¯¹è±¡çš„å­˜å‚¨æ€§èƒ½ï¼Ÿ
SOOæ ¸å¿ƒåŸç†ï¼šæ™ºèƒ½çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ åŸºæœ¬æ€æƒ³ å°å¯¹è±¡ä¼˜åŒ–çš„æ ¸å¿ƒç­–ç•¥æ˜¯åœ¨å®¹å™¨å¯¹è±¡å†…éƒ¨é¢„ç•™ä¸€ä¸ªå›ºå®šå¤§å°çš„å†…éƒ¨ç¼“å†²åŒºï¼ˆInternal Bufferï¼‰ã€‚è¿™ä¸ªç¼“å†²åŒºä½œä¸º&#34;å¿«é€Ÿé€šé“&#34;ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å°å¯¹è±¡çš„æ•°æ®ã€‚
å¤§å°åˆ¤å®šé€»è¾‘ SOOçš„å·¥ä½œæœºåˆ¶å¯ä»¥ç”¨ç®€å•çš„æ¡ä»¶åˆ¤æ–­æ¥æè¿°ï¼š
if (required_size &lt;= internal_buffer_size) { // ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºï¼Œæ— éœ€å †åˆ†é… store_in_internal_buffer(data); } else { // é€€å›åˆ°ä¼ ç»Ÿçš„å †å†…å­˜åˆ†é… allocate_on_heap(data); } Zero-OverheadæŠ½è±¡ SOOçš„ç²¾å¦™ä¹‹å¤„åœ¨äºå¯¹ä½¿ç”¨è€…å®Œå…¨é€æ˜ã€‚æ— è®ºåº•å±‚ä½¿ç”¨çš„æ˜¯å†…éƒ¨ç¼“å†²åŒºè¿˜æ˜¯å †å†…å­˜ï¼Œå®¹å™¨æä¾›çš„æ¥å£è¡Œä¸ºå®Œå…¨ä¸€è‡´ï¼Œè¿™ä½“ç°äº†C&#43;&#43;ä¸­&#34;Zero-Overhead&#34;æŠ½è±¡çš„è®¾è®¡ç†å¿µã€‚
å®ç°å‰–æï¼šä»¥std::stringä¸ºä¾‹ å…¸å‹æ•°æ®ç»“æ„è®¾è®¡ ä¸€ä¸ªæ”¯æŒSOOçš„std::stringå†…éƒ¨ç»“æ„å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š
class optimized_string { private: static constexpr size_t INTERNAL_BUFFER_SIZE = 15; union { // å¤§å¯¹è±¡æ¨¡å¼ï¼šæŒ‡å‘å †å†…å­˜ struct { char* ptr; size_t size; size_t capacity; } heap_data; // å°å¯¹è±¡æ¨¡å¼ï¼šç›´æ¥å­˜å‚¨åœ¨å¯¹è±¡å†…éƒ¨ struct { char buffer[INTERNAL_BUFFER_SIZE &#43; 1]; // &#43;1 for null terminator unsigned char remaining_size; // ç”¨äºæ ‡è¯†å½“å‰æ¨¡å¼å’Œå‰©ä½™ç©ºé—´ } stack_data; }; public: bool is_using_soo() const { // é€šè¿‡ç‰¹å®šä½æˆ–å€¼åˆ¤æ–­å½“å‰ä½¿ç”¨çš„å­˜å‚¨æ¨¡å¼ return stack_data.remaining_size &lt;= INTERNAL_BUFFER_SIZE; } const char* data() const { return is_using_soo() ? stack_data.buffer : heap_data.ptr; } size_t size() const { return is_using_soo() ? (INTERNAL_BUFFER_SIZE - stack_data.remaining_size) : heap_data.size; } }; çŠ¶æ€åŒºåˆ†æœºåˆ¶ åŒºåˆ†å½“å‰ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºè¿˜æ˜¯å †å†…å­˜æ˜¯SOOå®ç°çš„å…³é”®æŠ€æœ¯ç‚¹ã€‚å¸¸è§ç­–ç•¥åŒ…æ‹¬ï¼š">

      <link rel="stylesheet" href="/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css" integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H&#43;ZeT/jBpieRZ8=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/bundle.min.e139b0e3b3aff8f0e8e0272554b671a06c857a42278b36c539d96c69ddee2ca2.css" integrity="sha256-4Tmw47Ov&#43;PDo4CclVLZxoGyFekInizbFOdlsad3uLKI=" crossorigin="anonymous">

      <script src="/js/bundle.995e4ec99401021e081ec256bee66154ef7f4e5136809432513b2e6d014b4b1d.js" integrity="sha256-mV5OyZQBAh4IHsJWvuZhVO9/TlE2gJQyUTsubQFLSx0=" crossorigin="anonymous"></script><script defer src="/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js" integrity="sha256-ZFlLEl97eL30&#43;oMWlVkiu&#43;uxzWuu8/FmVL/KIDCfGPg="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="/" style="color: inherit;">Luyangã®Blog</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/features/"
      >Features</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/features/"
      >Features</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbspÂ»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="/posts/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbspÂ»&nbsp</span>
</ol>
<h1>ğŸ“Œå°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC&#43;&#43;å®¹å™¨çš„æ€§èƒ½åˆ©å™¨</h1><time class="dim" datetime="2025-06-04T02:30:00&#43;08:00">June 4, 2025</time><div class="term-container"><div class="tag">
        <a href="/tags/cpp/">#cpp</a>
      </div><div class="tag">
        <a href="/tags/soo/">#SOO</a>
      </div></ol></div>
  <section class="page-section"><h1 id="å°å¯¹è±¡ä¼˜åŒ–small-object-optimizationæ·±åº¦è§£æcå®¹å™¨çš„æ€§èƒ½åˆ©å™¨">å°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimizationï¼‰æ·±åº¦è§£æï¼šC++å®¹å™¨çš„æ€§èƒ½åˆ©å™¨</h1>
<h2 id="å¼•è¨€">å¼•è¨€</h2>
<p>åœ¨ç°ä»£C++å¼€å‘ä¸­ï¼Œ<code>std::string</code>å’Œ<code>std::vector</code>ç­‰æ ‡å‡†å®¹å™¨çš„é«˜æ•ˆæ€§å¾€å¾€è¢«å¼€å‘è€…è§†ä¸ºç†æ‰€å½“ç„¶ã€‚ç„¶è€Œï¼Œè¿™äº›å®¹å™¨åœ¨å¤„ç†å°å¯¹è±¡æ—¶çš„å“è¶Šæ€§èƒ½èƒŒåï¼Œéšè—ç€ä¸€é¡¹é‡è¦çš„ä¼˜åŒ–æŠ€æœ¯â€”â€”<strong>å°å¯¹è±¡ä¼˜åŒ–ï¼ˆSmall Object Optimization, SOOï¼‰</strong>ã€‚å¯¹äºè¿½æ±‚é«˜æ€§èƒ½çš„C++å¼€å‘è€…è€Œè¨€ï¼Œç†è§£SOOçš„å·¥ä½œåŸç†ä¸ä»…æœ‰åŠ©äºç¼–å†™æ›´é«˜æ•ˆçš„ä»£ç ï¼Œæ›´èƒ½å¯å‘æˆ‘ä»¬åœ¨è®¾è®¡è‡ªå®šä¹‰å®¹å™¨æ—¶é‡‡ç”¨ç±»ä¼¼çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<h2 id="é—®é¢˜èƒŒæ™¯å°å¯¹è±¡çš„æ€§èƒ½å›°å¢ƒ">é—®é¢˜èƒŒæ™¯ï¼šå°å¯¹è±¡çš„æ€§èƒ½å›°å¢ƒ</h2>
<h3 id="å †åˆ†é…çš„æ€§èƒ½å¼€é”€">å †åˆ†é…çš„æ€§èƒ½å¼€é”€</h3>
<p>å½“æˆ‘ä»¬ä½¿ç”¨<code>std::string</code>æˆ–<code>std::vector</code>å­˜å‚¨æ•°æ®æ—¶ï¼Œè¿™äº›å®¹å™¨é€šå¸¸éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜æ¥å­˜å‚¨å®é™…æ•°æ®ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼Œå †åˆ†é…çš„å¼€é”€ç›¸å¯¹äºæ•°æ®å¤„ç†æˆæœ¬è€Œè¨€æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬é¢‘ç¹å¤„ç†å°å¯¹è±¡æ—¶ï¼Œæƒ…å†µå°±æˆªç„¶ä¸åŒäº†ï¼š</p>
<ul>
<li><strong>åˆ†é…å™¨å¼€é”€</strong>ï¼šæ¯æ¬¡è°ƒç”¨<code>new</code>/<code>delete</code>æˆ–<code>malloc</code>/<code>free</code>éƒ½æ¶‰åŠå¤æ‚çš„å†…å­˜ç®¡ç†ç®—æ³•ï¼ŒåŒ…æ‹¬å¯»æ‰¾åˆé€‚å¤§å°çš„å†…å­˜å—ã€ç»´æŠ¤ç©ºé—²åˆ—è¡¨ç­‰</li>
<li><strong>å†…å­˜ç¢ç‰‡</strong>ï¼šå¤§é‡å°å†…å­˜å—çš„åˆ†é…å’Œé‡Šæ”¾ä¼šå¯¼è‡´å †å†…å­˜ç¢ç‰‡åŒ–ï¼Œé™ä½å†…å­˜åˆ©ç”¨ç‡</li>
<li><strong>ç¼“å­˜å±€éƒ¨æ€§å·®</strong>ï¼šå †ä¸Šåˆ†é…çš„å°å¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†å¸ƒæ•£ä¹±ï¼Œè®¿é—®æ—¶ç¼“å­˜å‘½ä¸­ç‡ä½</li>
</ul>
<h3 id="ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™">ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™</h3>
<p>æ ˆä¸Šåˆ†é…è™½ç„¶é€Ÿåº¦æå¿«ï¼Œä½†å—é™äºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ— æ³•æ»¡è¶³å®¹å™¨éœ€è¦åŠ¨æ€è°ƒæ•´å¤§å°çš„éœ€æ±‚ã€‚è€Œçº¯ç²¹çš„å †åˆ†é…è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†çŸ­å­—ç¬¦ä¸²ã€å°å®¹é‡å‘é‡ç­‰é«˜é¢‘åœºæ™¯æ—¶ï¼Œæ€§èƒ½å¼€é”€å˜å¾—ä¸å¯å¿½è§†ã€‚</p>
<p><strong>æ ¸å¿ƒé—®é¢˜</strong>ï¼šå¦‚ä½•ä¸ºéœ€è¦åŠ¨æ€å†…å­˜ç®¡ç†çš„å®¹å™¨ä¼˜åŒ–å°å¯¹è±¡çš„å­˜å‚¨æ€§èƒ½ï¼Ÿ</p>
<h2 id="sooæ ¸å¿ƒåŸç†æ™ºèƒ½çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥">SOOæ ¸å¿ƒåŸç†ï¼šæ™ºèƒ½çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥</h2>
<h3 id="åŸºæœ¬æ€æƒ³">åŸºæœ¬æ€æƒ³</h3>
<p><strong>å°å¯¹è±¡ä¼˜åŒ–çš„æ ¸å¿ƒç­–ç•¥</strong>æ˜¯åœ¨å®¹å™¨å¯¹è±¡å†…éƒ¨é¢„ç•™ä¸€ä¸ª<strong>å›ºå®šå¤§å°çš„å†…éƒ¨ç¼“å†²åŒºï¼ˆInternal Bufferï¼‰</strong>ã€‚è¿™ä¸ªç¼“å†²åŒºä½œä¸º&quot;å¿«é€Ÿé€šé“&quot;ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å°å¯¹è±¡çš„æ•°æ®ã€‚</p>
<h3 id="å¤§å°åˆ¤å®šé€»è¾‘">å¤§å°åˆ¤å®šé€»è¾‘</h3>
<p>SOOçš„å·¥ä½œæœºåˆ¶å¯ä»¥ç”¨ç®€å•çš„æ¡ä»¶åˆ¤æ–­æ¥æè¿°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (required_size <span style="color:#f92672">&lt;=</span> internal_buffer_size) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºï¼Œæ— éœ€å †åˆ†é…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    store_in_internal_buffer(data);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é€€å›åˆ°ä¼ ç»Ÿçš„å †å†…å­˜åˆ†é…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    allocate_on_heap(data);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="zero-overheadæŠ½è±¡">Zero-OverheadæŠ½è±¡</h3>
<p>SOOçš„ç²¾å¦™ä¹‹å¤„åœ¨äºå¯¹ä½¿ç”¨è€…å®Œå…¨é€æ˜ã€‚æ— è®ºåº•å±‚ä½¿ç”¨çš„æ˜¯å†…éƒ¨ç¼“å†²åŒºè¿˜æ˜¯å †å†…å­˜ï¼Œå®¹å™¨æä¾›çš„æ¥å£è¡Œä¸ºå®Œå…¨ä¸€è‡´ï¼Œè¿™ä½“ç°äº†C++ä¸­&quot;Zero-Overhead&quot;æŠ½è±¡çš„è®¾è®¡ç†å¿µã€‚</p>
<h2 id="å®ç°å‰–æä»¥stdstringä¸ºä¾‹">å®ç°å‰–æï¼šä»¥std::stringä¸ºä¾‹</h2>
<h3 id="å…¸å‹æ•°æ®ç»“æ„è®¾è®¡">å…¸å‹æ•°æ®ç»“æ„è®¾è®¡</h3>
<p>ä¸€ä¸ªæ”¯æŒSOOçš„<code>std::string</code>å†…éƒ¨ç»“æ„å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">optimized_string</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> size_t INTERNAL_BUFFER_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¤§å¯¹è±¡æ¨¡å¼ï¼šæŒ‡å‘å †å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ptr;
</span></span><span style="display:flex;"><span>            size_t size;
</span></span><span style="display:flex;"><span>            size_t capacity;
</span></span><span style="display:flex;"><span>        } heap_data;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°å¯¹è±¡æ¨¡å¼ï¼šç›´æ¥å­˜å‚¨åœ¨å¯¹è±¡å†…éƒ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> buffer[INTERNAL_BUFFER_SIZE <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]; <span style="color:#75715e">// +1 for null terminator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> remaining_size; <span style="color:#75715e">// ç”¨äºæ ‡è¯†å½“å‰æ¨¡å¼å’Œå‰©ä½™ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } stack_data;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> is_using_soo() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é€šè¿‡ç‰¹å®šä½æˆ–å€¼åˆ¤æ–­å½“å‰ä½¿ç”¨çš„å­˜å‚¨æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> stack_data.remaining_size <span style="color:#f92672">&lt;=</span> INTERNAL_BUFFER_SIZE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">data</span>() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> is_using_soo() <span style="color:#f92672">?</span> stack_data.buffer : heap_data.ptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">size</span>() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> is_using_soo() <span style="color:#f92672">?</span> 
</span></span><span style="display:flex;"><span>               (INTERNAL_BUFFER_SIZE <span style="color:#f92672">-</span> stack_data.remaining_size) <span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>               heap_data.size;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="çŠ¶æ€åŒºåˆ†æœºåˆ¶">çŠ¶æ€åŒºåˆ†æœºåˆ¶</h3>
<p>åŒºåˆ†å½“å‰ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºè¿˜æ˜¯å †å†…å­˜æ˜¯SOOå®ç°çš„å…³é”®æŠ€æœ¯ç‚¹ã€‚å¸¸è§ç­–ç•¥åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>åˆ©ç”¨å®¹é‡å­—æ®µçš„ç‰¹æ®Šå€¼</strong>ï¼šå½“<code>capacity</code>ä¸ºæŸä¸ªç‰¹æ®Šå€¼æ—¶è¡¨ç¤ºä½¿ç”¨å†…éƒ¨ç¼“å†²åŒº</li>
<li><strong>ä¸“ç”¨æ ‡å¿—ä½</strong>ï¼šä½¿ç”¨<code>remaining_size</code>å­—æ®µæ—¢å­˜å‚¨å‰©ä½™ç©ºé—´ä¿¡æ¯ï¼Œåˆä½œä¸ºçŠ¶æ€æ ‡è¯†</li>
<li><strong>æŒ‡é’ˆå€¼åˆ¤æ–­</strong>ï¼šé€šè¿‡æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦æŒ‡å‘å†…éƒ¨ç¼“å†²åŒºæ¥åˆ¤æ–­çŠ¶æ€</li>
</ul>
<h2 id="æºç å®ç°åŸç†æ·±åº¦å‰–æ">æºç å®ç°åŸç†æ·±åº¦å‰–æ</h2>
<h3 id="å®Œæ•´çš„sooå®ç°æ¡†æ¶">å®Œæ•´çš„SOOå®ç°æ¡†æ¶</h3>
<p>ä¸ºäº†æ·±å…¥ç†è§£SOOçš„å·¥ä½œæœºåˆ¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ›´å®Œæ•´çš„å®ç°æ¡†æ¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">soo_string</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> size_t SSO_BUFFER_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> size_t SSO_MASK <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80</span>;  <span style="color:#75715e">// æœ€é«˜ä½ä½œä¸ºæ ‡å¿—ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">union</span> <span style="color:#a6e22e">data_union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é•¿å­—ç¬¦ä¸²æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">long_string</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ptr;
</span></span><span style="display:flex;"><span>            size_t size;
</span></span><span style="display:flex;"><span>            size_t capacity;
</span></span><span style="display:flex;"><span>        } long_data;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çŸ­å­—ç¬¦ä¸²æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">short_string</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> buffer[SSO_BUFFER_SIZE];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> info;  <span style="color:#75715e">// å­˜å‚¨é•¿åº¦å’Œæ ‡å¿—ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } short_data;
</span></span><span style="display:flex;"><span>    } data_;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ ¸å¿ƒçŠ¶æ€åˆ¤æ–­å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">is_short</span>() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (data_.short_data.info <span style="color:#f92672">&amp;</span> SSO_MASK) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">short_size</span>() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SSO_BUFFER_SIZE <span style="color:#f92672">-</span> (data_.short_data.info <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>SSO_MASK);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_short_size</span>(size_t size) <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        data_.short_data.info <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(SSO_BUFFER_SIZE <span style="color:#f92672">-</span> size);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_long_data</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ptr, size_t size, size_t cap) <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        data_.long_data.ptr <span style="color:#f92672">=</span> ptr;
</span></span><span style="display:flex;"><span>        data_.long_data.size <span style="color:#f92672">=</span> size;
</span></span><span style="display:flex;"><span>        data_.long_data.capacity <span style="color:#f92672">=</span> cap <span style="color:#f92672">|</span> SSO_MASK;  <span style="color:#75715e">// è®¾ç½®æ ‡å¿—ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é»˜è®¤æ„é€ å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    soo_string() <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        data_.short_data.buffer[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>        set_short_size(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä»Cå­—ç¬¦ä¸²æ„é€ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    soo_string(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> str) {
</span></span><span style="display:flex;"><span>        size_t len <span style="color:#f92672">=</span> strlen(str);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&lt;=</span> SSO_BUFFER_SIZE) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ä½¿ç”¨çŸ­å­—ç¬¦ä¸²ä¼˜åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            memcpy(data_.short_data.buffer, str, len);
</span></span><span style="display:flex;"><span>            data_.short_data.buffer[len] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            set_short_size(len);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// åˆ†é…å †å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> new_ptr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            memcpy(new_ptr, str, len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            set_long_data(new_ptr, len, len);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ‹·è´æ„é€ å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    soo_string(<span style="color:#66d9ef">const</span> soo_string<span style="color:#f92672">&amp;</span> other) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (other.is_short()) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¤åˆ¶çŸ­å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            data_.short_data <span style="color:#f92672">=</span> other.data_.short_data;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¤åˆ¶é•¿å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            size_t len <span style="color:#f92672">=</span> other.data_.long_data.size;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> new_ptr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            memcpy(new_ptr, other.data_.long_data.ptr, len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            set_long_data(new_ptr, len, len);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç§»åŠ¨æ„é€ å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    soo_string(soo_string<span style="color:#f92672">&amp;&amp;</span> other) <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (other.is_short()) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// çŸ­å­—ç¬¦ä¸²éœ€è¦å¤åˆ¶æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            data_.short_data <span style="color:#f92672">=</span> other.data_.short_data;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// é•¿å­—ç¬¦ä¸²å¯ä»¥ç›´æ¥ç§»åŠ¨æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            data_.long_data <span style="color:#f92672">=</span> other.data_.long_data;
</span></span><span style="display:flex;"><span>            other.data_.short_data.buffer[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            other.set_short_size(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ææ„å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">~</span>soo_string() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>is_short()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">delete</span>[] data_.long_data.ptr;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¿é—®å™¨å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">c_str</span>() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> is_short() <span style="color:#f92672">?</span> data_.short_data.buffer : data_.long_data.ptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">size</span>() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> is_short() <span style="color:#f92672">?</span> short_size() <span style="color:#f92672">:</span> data_.long_data.size;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">capacity</span>() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> is_short() <span style="color:#f92672">?</span> SSO_BUFFER_SIZE : (data_.long_data.capacity <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>SSO_MASK);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="å…³é”®å®ç°ç»†èŠ‚è§£æ">å…³é”®å®ç°ç»†èŠ‚è§£æ</h3>
<h4 id="1-æ ‡å¿—ä½å·§å¦™è®¾è®¡">1. æ ‡å¿—ä½å·§å¦™è®¾è®¡</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// åˆ©ç”¨capacityå­—æ®µçš„æœ€é«˜ä½ä½œä¸ºæ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// é•¿å­—ç¬¦ä¸²: capacity |= SSO_MASK (æœ€é«˜ä½ä¸º1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// çŸ­å­—ç¬¦ä¸²: infoå­—æ®µæœ€é«˜ä½ä¸º0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> size_t SSO_MASK <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80</span>;
</span></span></code></pre></div><h4 id="2-å†…å­˜å¸ƒå±€ä¼˜åŒ–">2. å†…å­˜å¸ƒå±€ä¼˜åŒ–</h4>
<p>çŸ­å­—ç¬¦ä¸²æ¨¡å¼ä¸‹ï¼Œ<code>info</code>å­—æ®µæ—¢å­˜å‚¨é•¿åº¦ä¿¡æ¯åˆä½œä¸ºçŠ¶æ€æ ‡è¯†ï¼š</p>
<ul>
<li><code>info = SSO_BUFFER_SIZE - actual_length</code></li>
<li>æœ€é«˜ä½å§‹ç»ˆä¸º0ï¼Œè¡¨ç¤ºçŸ­å­—ç¬¦ä¸²æ¨¡å¼</li>
</ul>
<h4 id="3-åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–">3. åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ç¼–è¯‘å™¨ä¼˜åŒ–ï¼šçŸ­å­—ç¬¦ä¸²æ˜¯å¸¸è§æƒ…å†µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (is_short()) <span style="color:#a6e22e">[[likely]]</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// çŸ­å­—ç¬¦ä¸²å¤„ç†é€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é•¿å­—ç¬¦ä¸²å¤„ç†é€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="ä¸åŒåœºæ™¯ä¸‹çš„è°ƒç”¨æµç¨‹åˆ†æ">ä¸åŒåœºæ™¯ä¸‹çš„è°ƒç”¨æµç¨‹åˆ†æ</h2>
<h3 id="åœºæ™¯1çŸ­å­—ç¬¦ä¸²æ„é€ æµç¨‹">åœºæ™¯1ï¼šçŸ­å­—ç¬¦ä¸²æ„é€ æµç¨‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>soo_string <span style="color:#a6e22e">str</span>(<span style="color:#e6db74">&#34;Hello&#34;</span>);  <span style="color:#75715e">// 5ä¸ªå­—ç¬¦ï¼Œå°äºSSO_BUFFER_SIZE(15)
</span></span></span></code></pre></div><p><strong>è°ƒç”¨æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// 1. è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t len <span style="color:#f92672">=</span> strlen(<span style="color:#e6db74">&#34;Hello&#34;</span>);  <span style="color:#75715e">// len = 5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. é•¿åº¦åˆ¤æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&lt;=</span> SSO_BUFFER_SIZE) {  <span style="color:#75715e">// 5 &lt;= 15, æ¡ä»¶æˆç«‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. ç›´æ¥å¤åˆ¶åˆ°å†…éƒ¨ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memcpy(data_.short_data.buffer, <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>    data_.short_data.buffer[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. è®¾ç½®é•¿åº¦ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    set_short_size(<span style="color:#ae81ff">5</span>);  <span style="color:#75715e">// info = 15 - 5 = 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. æ— å †åˆ†é…ï¼Œæ„é€ å®Œæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>æ€§èƒ½ç‰¹å¾ï¼š</strong></p>
<ul>
<li>æ—¶é—´ë³µæ‚åº¦ï¼šO(1)</li>
<li>å†…å­˜åˆ†é…ï¼š0æ¬¡å †åˆ†é…</li>
<li>ç¼“å­˜å‹å¥½ï¼šæ•°æ®å­˜å‚¨åœ¨å¯¹è±¡å†…éƒ¨</li>
</ul>
<h3 id="åœºæ™¯2é•¿å­—ç¬¦ä¸²æ„é€ æµç¨‹">åœºæ™¯2ï¼šé•¿å­—ç¬¦ä¸²æ„é€ æµç¨‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>soo_string <span style="color:#a6e22e">str</span>(<span style="color:#e6db74">&#34;This is a very long string that exceeds the buffer size&#34;</span>);
</span></span></code></pre></div><p><strong>è°ƒç”¨æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// 1. è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t len <span style="color:#f92672">=</span> strlen(input);  <span style="color:#75715e">// len = 58 &gt; 15
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. é•¿åº¦åˆ¤æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&lt;=</span> SSO_BUFFER_SIZE) {  <span style="color:#75715e">// 58 &lt;= 15, æ¡ä»¶ä¸æˆç«‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// è·³è¿‡æ­¤åˆ†æ”¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. åˆ†é…å †å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> new_ptr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];  <span style="color:#75715e">// åˆ†é…59å­—èŠ‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. å¤åˆ¶æ•°æ®åˆ°å †
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memcpy(new_ptr, input, len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. è®¾ç½®é•¿å­—ç¬¦ä¸²æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    set_long_data(new_ptr, len, len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// data_.long_data.ptr = new_ptr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// data_.long_data.size = 58
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// data_.long_data.capacity = 58 | SSO_MASK  // è®¾ç½®æ ‡å¿—ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>æ€§èƒ½ç‰¹å¾ï¼š</strong></p>
<ul>
<li>æ—¶é—´å¤æ‚åº¦ï¼šO(n) + å †åˆ†é…å¼€é”€</li>
<li>å†…å­˜åˆ†é…ï¼š1æ¬¡å †åˆ†é…</li>
<li>é¢å¤–å¼€é”€ï¼šåˆ†é…å™¨è°ƒç”¨ã€å†…å­˜ç®¡ç†å¼€é”€</li>
</ul>
<h3 id="åœºæ™¯3çŸ­å­—ç¬¦ä¸²å¤åˆ¶æµç¨‹">åœºæ™¯3ï¼šçŸ­å­—ç¬¦ä¸²å¤åˆ¶æµç¨‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>soo_string <span style="color:#a6e22e">str1</span>(<span style="color:#e6db74">&#34;Hello&#34;</span>);
</span></span><span style="display:flex;"><span>soo_string str2 <span style="color:#f92672">=</span> str1;  <span style="color:#75715e">// æ‹·è´æ„é€ 
</span></span></span></code></pre></div><p><strong>è°ƒç”¨æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// 1. æ£€æŸ¥æºå­—ç¬¦ä¸²ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (other.is_short()) {  <span style="color:#75715e">// çŸ­å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. ç›´æ¥å¤åˆ¶unionæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    data_.short_data <span style="color:#f92672">=</span> other.data_.short_data;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åŒ…æ‹¬bufferå’Œinfoå­—æ®µçš„å®Œæ•´å¤åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. æ— éœ€é¢å¤–åˆ†é…ï¼Œå¤åˆ¶å®Œæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>æ€§èƒ½ç‰¹å¾ï¼š</strong></p>
<ul>
<li>æ—¶é—´å¤æ‚åº¦ï¼šO(1)</li>
<li>å†…å­˜åˆ†é…ï¼š0æ¬¡</li>
<li>æ“ä½œï¼šç®€å•çš„å†…å­˜å¤åˆ¶</li>
</ul>
<h3 id="åœºæ™¯4é•¿å­—ç¬¦ä¸²ç§»åŠ¨æµç¨‹">åœºæ™¯4ï¼šé•¿å­—ç¬¦ä¸²ç§»åŠ¨æµç¨‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>soo_string <span style="color:#a6e22e">str1</span>(<span style="color:#e6db74">&#34;Very long string...&#34;</span>);
</span></span><span style="display:flex;"><span>soo_string str2 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>move(str1);  <span style="color:#75715e">// ç§»åŠ¨æ„é€ 
</span></span></span></code></pre></div><p><strong>è°ƒç”¨æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// 1. æ£€æŸ¥æºå­—ç¬¦ä¸²ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (other.is_short()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// çŸ­å­—ç¬¦ä¸²æ— æ³•çœŸæ­£&#34;ç§»åŠ¨&#34;ï¼Œéœ€è¦å¤åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    data_.short_data <span style="color:#f92672">=</span> other.data_.short_data;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. é•¿å­—ç¬¦ä¸²ï¼šè½¬ç§»æ‰€æœ‰æƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    data_.long_data <span style="color:#f92672">=</span> other.data_.long_data;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. é‡ç½®æºå¯¹è±¡ä¸ºç©ºçŸ­å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    other.data_.short_data.buffer[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    other.set_short_size(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. æŒ‡é’ˆè½¬ç§»å®Œæˆï¼Œæ— éœ€å¤åˆ¶æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>æ€§èƒ½ç‰¹å¾ï¼š</strong></p>
<ul>
<li>é•¿å­—ç¬¦ä¸²ï¼šO(1)ï¼Œä»…æŒ‡é’ˆè½¬ç§»</li>
<li>çŸ­å­—ç¬¦ä¸²ï¼šO(1)ï¼Œä½†éœ€è¦æ•°æ®å¤åˆ¶</li>
</ul>
<h3 id="åœºæ™¯5åŠ¨æ€å¢é•¿æµç¨‹">åœºæ™¯5ï¼šåŠ¨æ€å¢é•¿æµç¨‹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>soo_string <span style="color:#a6e22e">str</span>(<span style="color:#e6db74">&#34;Hello&#34;</span>);
</span></span><span style="display:flex;"><span>str <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34; World! This makes it longer than 15 characters&#34;</span>;
</span></span></code></pre></div><p><strong>è°ƒç”¨æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// 1. è®¡ç®—æ–°é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t current_len <span style="color:#f92672">=</span> str.size();  <span style="color:#75715e">// 5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t append_len <span style="color:#f92672">=</span> strlen(<span style="color:#e6db74">&#34; World! ...&#34;</span>);  <span style="color:#75715e">// 48
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>size_t new_len <span style="color:#f92672">=</span> current_len <span style="color:#f92672">+</span> append_len;  <span style="color:#75715e">// 53
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬æ¢ä¸ºé•¿å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (str.is_short() <span style="color:#f92672">&amp;&amp;</span> new_len <span style="color:#f92672">&gt;</span> SSO_BUFFER_SIZE) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. åˆ†é…æ–°çš„å †å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> new_ptr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[new_len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. å¤åˆ¶åŸæœ‰æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memcpy(new_ptr, str.data_.short_data.buffer, current_len);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. è¿½åŠ æ–°æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memcpy(new_ptr <span style="color:#f92672">+</span> current_len, append_data, append_len);
</span></span><span style="display:flex;"><span>    new_ptr[new_len] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 6. è½¬æ¢ä¸ºé•¿å­—ç¬¦ä¸²æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    str.set_long_data(new_ptr, new_len, new_len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ€§èƒ½ç‰¹å¾ï¼š</strong></p>
<ul>
<li>æ¶‰åŠæ¨¡å¼è½¬æ¢ï¼šä¸€æ¬¡æ€§çš„è½¬æ¢å¼€é”€</li>
<li>åç»­æ“ä½œï¼šæŒ‰é•¿å­—ç¬¦ä¸²æ¨¡å¼å¤„ç†</li>
<li>å†…å­˜é‡åˆ†é…ï¼šä¸å¯é¿å…ï¼Œä½†ä»…åœ¨è½¬æ¢æ—¶å‘ç”Ÿä¸€æ¬¡</li>
</ul>
<h3 id="æ€§èƒ½å¯¹æ¯”æ€»ç»“">æ€§èƒ½å¯¹æ¯”æ€»ç»“</h3>
<table>
  <thead>
      <tr>
          <th>æ“ä½œåœºæ™¯</th>
          <th>çŸ­å­—ç¬¦ä¸²(SOO)</th>
          <th>é•¿å­—ç¬¦ä¸²</th>
          <th>æ€§èƒ½å·®å¼‚</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>æ„é€ </td>
          <td>O(1), 0æ¬¡åˆ†é…</td>
          <td>O(n), 1æ¬¡åˆ†é…</td>
          <td>10-100å€</td>
      </tr>
      <tr>
          <td>æ‹·è´</td>
          <td>O(1), 0æ¬¡åˆ†é…</td>
          <td>O(n), 1æ¬¡åˆ†é…</td>
          <td>5-50å€</td>
      </tr>
      <tr>
          <td>ç§»åŠ¨</td>
          <td>O(1), éœ€å¤åˆ¶</td>
          <td>O(1), ä»…æŒ‡é’ˆ</td>
          <td>çŸ­å­—ç¬¦ä¸²ç•¥æ…¢</td>
      </tr>
      <tr>
          <td>è®¿é—®</td>
          <td>O(1), é«˜ç¼“å­˜å‘½ä¸­</td>
          <td>O(1), å¯èƒ½ç¼“å­˜miss</td>
          <td>1.5-3å€</td>
      </tr>
      <tr>
          <td>ææ„</td>
          <td>O(1), æ— æ“ä½œ</td>
          <td>O(1), 1æ¬¡é‡Šæ”¾</td>
          <td>5-20å€</td>
      </tr>
  </tbody>
</table>
<h2 id="æ€§èƒ½ä¼˜åŠ¿åˆ†æ">æ€§èƒ½ä¼˜åŠ¿åˆ†æ</h2>
<h3 id="é‡åŒ–çš„æ€§èƒ½æå‡">é‡åŒ–çš„æ€§èƒ½æå‡</h3>
<p>SOOå¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿åœ¨å°å¯¹è±¡é¢‘ç¹æ“ä½œåœºæ™¯ä¸‹å°¤ä¸ºæ˜¾è‘—ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹ï¼ˆæ¦‚å¿µæ€§ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">performance_comparison</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åœºæ™¯1ï¼šSOOä¼˜åŒ–çš„çŸ­å­—ç¬¦ä¸²æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>string short_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello&#34;</span>;  <span style="color:#75715e">// ç›´æ¥å­˜å‚¨åœ¨å†…éƒ¨ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ—¶é—´å¤æ‚åº¦ï¼šO(1)ï¼Œæ— å †åˆ†é…å¼€é”€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åœºæ™¯2ï¼šè¶…å‡ºSOOé˜ˆå€¼çš„é•¿å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>string long_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;This is a very long string that exceeds buffer&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ—¶é—´å¤æ‚åº¦ï¼šO(1) + å †åˆ†é…å¼€é”€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åœ¨å¾ªç¯ä¸­åˆ›å»ºå¤§é‡çŸ­å­—ç¬¦ä¸²æ—¶ï¼ŒSOOå¯å¸¦æ¥æ•°å€æ€§èƒ½æå‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000000</span>; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>string temp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;short&#34;</span>;  <span style="color:#75715e">// SOOä¼˜åŒ–ï¼šæ ˆé€Ÿåº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// vs éä¼˜åŒ–ç‰ˆæœ¬éœ€è¦1000000æ¬¡å †åˆ†é…/é‡Šæ”¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å…·ä½“ä¼˜åŠ¿">å…·ä½“ä¼˜åŠ¿</h3>
<ol>
<li><strong>å‡å°‘åˆ†é…æ¬¡æ•°</strong>ï¼šå¯¹äºé•¿åº¦ä¸è¶…è¿‡é˜ˆå€¼çš„å­—ç¬¦ä¸²ï¼Œå®Œå…¨é¿å…å †åˆ†é…å™¨è°ƒç”¨</li>
<li><strong>æ”¹å–„å†…å­˜å±€éƒ¨æ€§</strong>ï¼šæ•°æ®å­˜å‚¨åœ¨å®¹å™¨å¯¹è±¡å†…éƒ¨ï¼Œä¸å…¶ä»–æˆå‘˜å˜é‡åœ¨åŒä¸€ç¼“å­˜è¡Œä¸­</li>
<li><strong>é™ä½å†…å­˜ç¢ç‰‡</strong>ï¼šå‡å°‘å †ä¸Šå°å†…å­˜å—çš„æ•°é‡ï¼Œæ”¹å–„æ•´ä½“å†…å­˜å¸ƒå±€</li>
<li><strong>æå‡å¹¶å‘æ€§èƒ½</strong>ï¼šå‡å°‘å¯¹å…¨å±€å †åˆ†é…å™¨çš„ç«äº‰</li>
</ol>
<h2 id="å…³é”®è€ƒé‡ä¸å±€é™">å…³é”®è€ƒé‡ä¸å±€é™</h2>
<h3 id="ç©ºé—´å¼€é”€æƒè¡¡">ç©ºé—´å¼€é”€æƒè¡¡</h3>
<p>SOOçš„<strong>ä¸»è¦ä»£ä»·æ˜¯å¢åŠ äº†æ¯ä¸ªå®¹å™¨å¯¹è±¡çš„å°ºå¯¸</strong>ã€‚å³ä½¿å­˜å‚¨å¤§å¯¹è±¡æ—¶ä½¿ç”¨å †åˆ†é…ï¼Œå†…éƒ¨ç¼“å†²åŒºçš„ç©ºé—´ä»ç„¶è¢«å ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">sizeof</span>(std<span style="color:#f92672">::</span>string) <span style="color:#75715e">// é€šå¸¸ä¸º24-32å­—èŠ‚ï¼ŒåŒ…å«å†…éƒ¨ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vs
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(size_t) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#75715e">// ä»…æŒ‡é’ˆ+å¤§å°ä¿¡æ¯çº¦ä¸º24å­—èŠ‚
</span></span></span></code></pre></div><p>è¿™ç§ç©ºé—´å¼€é”€åœ¨ä»¥ä¸‹åœºæ™¯ä¸­éœ€è¦ç‰¹åˆ«è€ƒè™‘ï¼š</p>
<ul>
<li>å­˜å‚¨å¤§é‡ç©ºå­—ç¬¦ä¸²æˆ–å°å­—ç¬¦ä¸²çš„å®¹å™¨ï¼ˆå¦‚<code>std::vector&lt;std::string&gt;</code>ï¼‰</li>
<li>å†…å­˜å—é™çš„åµŒå…¥å¼ç¯å¢ƒ</li>
<li>å¯¹è±¡å¤§å°æ•æ„Ÿçš„æ•°æ®ç»“æ„è®¾è®¡</li>
</ul>
<h3 id="ç¼“å†²åŒºå¤§å°çš„é€‰æ‹©è‰ºæœ¯">ç¼“å†²åŒºå¤§å°çš„é€‰æ‹©è‰ºæœ¯</h3>
<p>å†…éƒ¨ç¼“å†²åŒºå¤§å°çš„é€‰æ‹©éœ€è¦åœ¨ç©ºé—´å¼€é”€å’Œä¼˜åŒ–æ•ˆæœä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼š</p>
<ul>
<li><strong>libstdc++</strong>ï¼šé€šå¸¸ä¸º15å­—èŠ‚ï¼ˆç”¨äº<code>std::string</code>ï¼‰</li>
<li><strong>libc++</strong>ï¼šå¯èƒ½é€‰æ‹©22å­—èŠ‚æˆ–å…¶ä»–å€¼</li>
<li><strong>MSVC</strong>ï¼šæ ¹æ®ç›®æ ‡æ¶æ„å¯èƒ½æœ‰ä¸åŒé€‰æ‹©</li>
</ul>
<p>é€‰æ‹©è¿‡å°ä¼šé™ä½ä¼˜åŒ–è¦†ç›–ç‡ï¼Œé€‰æ‹©è¿‡å¤§ä¼šå¢åŠ ä¸å¿…è¦çš„ç©ºé—´å¼€é”€ã€‚</p>
<h3 id="ç§»åŠ¨è¯­ä¹‰çš„å¤æ‚æ€§">ç§»åŠ¨è¯­ä¹‰çš„å¤æ‚æ€§</h3>
<p>SOOå¯¹ç§»åŠ¨æ“ä½œå¸¦æ¥äº†é¢å¤–è€ƒè™‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ç§»åŠ¨SOOå¯¹è±¡æ—¶çš„è€ƒè™‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>optimized_string str1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;short&#34;</span>;    <span style="color:#75715e">// ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>optimized_string str2 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>move(str1);  <span style="color:#75715e">// éœ€è¦å¤åˆ¶å†…éƒ¨ç¼“å†²åŒºæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// vs ç§»åŠ¨å¤§å¯¹è±¡æ—¶åªéœ€äº¤æ¢æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>optimized_string long_str1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;very long string...&#34;</span>;
</span></span><span style="display:flex;"><span>optimized_string long_str2 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>move(long_str1);  <span style="color:#75715e">// ä»…æŒ‡é’ˆäº¤æ¢
</span></span></span></code></pre></div><h2 id="å®ç”¨ä»·å€¼ä¸åº”ç”¨å¯å‘">å®ç”¨ä»·å€¼ä¸åº”ç”¨å¯å‘</h2>
<h3 id="ç°å®åº”ç”¨åœºæ™¯">ç°å®åº”ç”¨åœºæ™¯</h3>
<p>SOOåœ¨ä»¥ä¸‹é«˜é¢‘åœºæ™¯ä¸­å‘æŒ¥é‡è¦ä½œç”¨ï¼š</p>
<ul>
<li><strong>æ—¥å¿—ç³»ç»Ÿ</strong>ï¼šå¤§é‡çŸ­æ—¥å¿—æ¶ˆæ¯çš„å¤„ç†</li>
<li><strong>é…ç½®ç®¡ç†</strong>ï¼šé”®å€¼å¯¹ä¸­çš„çŸ­å­—ç¬¦ä¸²é”®å</li>
<li><strong>ä¸´æ—¶å­—ç¬¦ä¸²æ‹¼æ¥</strong>ï¼šå‡½æ•°å†…éƒ¨çš„ä¸´æ—¶å­—ç¬¦ä¸²æ“ä½œ</li>
<li><strong>å°å®¹é‡å‘é‡</strong>ï¼šåˆå§‹åŒ–æ—¶åªåŒ…å«å°‘é‡å…ƒç´ çš„<code>std::vector</code></li>
</ul>
<h3 id="è®¾è®¡å¯å‘">è®¾è®¡å¯å‘</h3>
<p>SOOçš„è®¾è®¡æ€æƒ³å¯ä»¥å¯å‘æˆ‘ä»¬åœ¨è®¾è®¡è‡ªå®šä¹‰å®¹å™¨æˆ–å°è£…ç±»æ—¶è€ƒè™‘ç±»ä¼¼ä¼˜åŒ–ï¼š</p>
<ol>
<li><strong>è¯†åˆ«å°å¯¹è±¡åœºæ™¯</strong>ï¼šåˆ†æä½ çš„åº”ç”¨ä¸­å“ªäº›æ•°æ®ç»“æ„ç»å¸¸å­˜å‚¨å°å¯¹è±¡</li>
<li><strong>æƒè¡¡ç©ºé—´æ—¶é—´</strong>ï¼šæ ¹æ®å…·ä½“ä½¿ç”¨æ¨¡å¼å†³å®šæ˜¯å¦å€¼å¾—å¼•å…¥å†…éƒ¨ç¼“å†²åŒº</li>
<li><strong>ä¿æŒæ¥å£ä¸€è‡´æ€§</strong>ï¼šç¡®ä¿ä¼˜åŒ–å¯¹ä½¿ç”¨è€…é€æ˜</li>
<li><strong>åŸºå‡†æµ‹è¯•éªŒè¯</strong>ï¼šé€šè¿‡å®é™…æµ‹é‡éªŒè¯ä¼˜åŒ–æ•ˆæœ</li>
</ol>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p><strong>å°å¯¹è±¡ä¼˜åŒ–</strong>ä»£è¡¨äº†C++æ ‡å‡†åº“åœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢çš„ç²¾å¦™è®¾è®¡ã€‚é€šè¿‡åœ¨å®¹å™¨å†…éƒ¨é¢„ç•™å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼ŒSOOæˆåŠŸåœ°ä¸ºå°å¯¹è±¡æä¾›äº†æ¥è¿‘æ ˆåˆ†é…çš„æ€§èƒ½ï¼ŒåŒæ—¶ä¿æŒäº†åŠ¨æ€å†…å­˜ç®¡ç†çš„çµæ´»æ€§ã€‚</p>
<p>è™½ç„¶SOOä¼šå¢åŠ å¯¹è±¡çš„ç©ºé—´å¼€é”€ï¼Œä½†åœ¨å¤„ç†å¤§é‡å°å¯¹è±¡çš„åœºæ™¯ä¸­ï¼Œå…¶å¸¦æ¥çš„æ€§èƒ½æå‡å¾€å¾€è¿œè¶…è¿‡ç©ºé—´æˆæœ¬ã€‚ç†è§£SOOä¸ä»…æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°ä½¿ç”¨æ ‡å‡†å®¹å™¨ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•é€šè¿‡å·§å¦™çš„è®¾è®¡åœ¨é«˜çº§æŠ½è±¡å’Œåº•å±‚æ€§èƒ½ä¹‹é—´æ‰¾åˆ°å®Œç¾å¹³è¡¡ã€‚</p>
<p>åœ¨è®¾è®¡é«˜æ€§èƒ½C++åº”ç”¨æ—¶ï¼ŒSOOæé†’æˆ‘ä»¬ï¼š<strong>æœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆå¾€å¾€ä¸æ˜¯å•ä¸€çš„æŠ€æœ¯ï¼Œè€Œæ˜¯é’ˆå¯¹ä¸åŒè§„æ¨¡é—®é¢˜é‡‡ç”¨ä¸åŒç­–ç•¥çš„æ™ºèƒ½ç»„åˆ</strong>ã€‚</p>
</section></main>
        <footer id="main-footer"><div class="footer">
  <a href="#">Scroll to Top</a>
  <div class="footer-copyright">
    <div class="dim">Â© 2025 Lu Yang</div>
    <div>Made with â¤ï¸ and powered by <a href="https://github.com/math-queiroz/rusty-typewriter" target="_blank">Rusty Typewriter</a> theme for <a href="https://gohugo.io/" target="_blank">Hugo</a></div>
  </div>
</div>
</footer>
      </div><aside id="side-pane" class="side-sticky"><div class="side-details">
    <span>961 words</span>
    <span>15 - 19 minutes read</span></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#å¼•è¨€">å¼•è¨€</a></li>
    <li><a href="#é—®é¢˜èƒŒæ™¯å°å¯¹è±¡çš„æ€§èƒ½å›°å¢ƒ">é—®é¢˜èƒŒæ™¯ï¼šå°å¯¹è±¡çš„æ€§èƒ½å›°å¢ƒ</a>
      <ul>
        <li><a href="#å †åˆ†é…çš„æ€§èƒ½å¼€é”€">å †åˆ†é…çš„æ€§èƒ½å¼€é”€</a></li>
        <li><a href="#ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™">ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™</a></li>
      </ul>
    </li>
    <li><a href="#sooæ ¸å¿ƒåŸç†æ™ºèƒ½çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥">SOOæ ¸å¿ƒåŸç†ï¼šæ™ºèƒ½çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥</a>
      <ul>
        <li><a href="#åŸºæœ¬æ€æƒ³">åŸºæœ¬æ€æƒ³</a></li>
        <li><a href="#å¤§å°åˆ¤å®šé€»è¾‘">å¤§å°åˆ¤å®šé€»è¾‘</a></li>
        <li><a href="#zero-overheadæŠ½è±¡">Zero-OverheadæŠ½è±¡</a></li>
      </ul>
    </li>
    <li><a href="#å®ç°å‰–æä»¥stdstringä¸ºä¾‹">å®ç°å‰–æï¼šä»¥std::stringä¸ºä¾‹</a>
      <ul>
        <li><a href="#å…¸å‹æ•°æ®ç»“æ„è®¾è®¡">å…¸å‹æ•°æ®ç»“æ„è®¾è®¡</a></li>
        <li><a href="#çŠ¶æ€åŒºåˆ†æœºåˆ¶">çŠ¶æ€åŒºåˆ†æœºåˆ¶</a></li>
      </ul>
    </li>
    <li><a href="#æºç å®ç°åŸç†æ·±åº¦å‰–æ">æºç å®ç°åŸç†æ·±åº¦å‰–æ</a>
      <ul>
        <li><a href="#å®Œæ•´çš„sooå®ç°æ¡†æ¶">å®Œæ•´çš„SOOå®ç°æ¡†æ¶</a></li>
        <li><a href="#å…³é”®å®ç°ç»†èŠ‚è§£æ">å…³é”®å®ç°ç»†èŠ‚è§£æ</a></li>
      </ul>
    </li>
    <li><a href="#ä¸åŒåœºæ™¯ä¸‹çš„è°ƒç”¨æµç¨‹åˆ†æ">ä¸åŒåœºæ™¯ä¸‹çš„è°ƒç”¨æµç¨‹åˆ†æ</a>
      <ul>
        <li><a href="#åœºæ™¯1çŸ­å­—ç¬¦ä¸²æ„é€ æµç¨‹">åœºæ™¯1ï¼šçŸ­å­—ç¬¦ä¸²æ„é€ æµç¨‹</a></li>
        <li><a href="#åœºæ™¯2é•¿å­—ç¬¦ä¸²æ„é€ æµç¨‹">åœºæ™¯2ï¼šé•¿å­—ç¬¦ä¸²æ„é€ æµç¨‹</a></li>
        <li><a href="#åœºæ™¯3çŸ­å­—ç¬¦ä¸²å¤åˆ¶æµç¨‹">åœºæ™¯3ï¼šçŸ­å­—ç¬¦ä¸²å¤åˆ¶æµç¨‹</a></li>
        <li><a href="#åœºæ™¯4é•¿å­—ç¬¦ä¸²ç§»åŠ¨æµç¨‹">åœºæ™¯4ï¼šé•¿å­—ç¬¦ä¸²ç§»åŠ¨æµç¨‹</a></li>
        <li><a href="#åœºæ™¯5åŠ¨æ€å¢é•¿æµç¨‹">åœºæ™¯5ï¼šåŠ¨æ€å¢é•¿æµç¨‹</a></li>
        <li><a href="#æ€§èƒ½å¯¹æ¯”æ€»ç»“">æ€§èƒ½å¯¹æ¯”æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#æ€§èƒ½ä¼˜åŠ¿åˆ†æ">æ€§èƒ½ä¼˜åŠ¿åˆ†æ</a>
      <ul>
        <li><a href="#é‡åŒ–çš„æ€§èƒ½æå‡">é‡åŒ–çš„æ€§èƒ½æå‡</a></li>
        <li><a href="#å…·ä½“ä¼˜åŠ¿">å…·ä½“ä¼˜åŠ¿</a></li>
      </ul>
    </li>
    <li><a href="#å…³é”®è€ƒé‡ä¸å±€é™">å…³é”®è€ƒé‡ä¸å±€é™</a>
      <ul>
        <li><a href="#ç©ºé—´å¼€é”€æƒè¡¡">ç©ºé—´å¼€é”€æƒè¡¡</a></li>
        <li><a href="#ç¼“å†²åŒºå¤§å°çš„é€‰æ‹©è‰ºæœ¯">ç¼“å†²åŒºå¤§å°çš„é€‰æ‹©è‰ºæœ¯</a></li>
        <li><a href="#ç§»åŠ¨è¯­ä¹‰çš„å¤æ‚æ€§">ç§»åŠ¨è¯­ä¹‰çš„å¤æ‚æ€§</a></li>
      </ul>
    </li>
    <li><a href="#å®ç”¨ä»·å€¼ä¸åº”ç”¨å¯å‘">å®ç”¨ä»·å€¼ä¸åº”ç”¨å¯å‘</a>
      <ul>
        <li><a href="#ç°å®åº”ç”¨åœºæ™¯">ç°å®åº”ç”¨åœºæ™¯</a></li>
        <li><a href="#è®¾è®¡å¯å‘">è®¾è®¡å¯å‘</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav><h3>Related</h3>
    <ul><li><a href="/posts/-c&#43;&#43;-%E7%B1%BB%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0-static-%E4%B8%8E-const-%E7%9A%84%E5%A3%B0%E6%98%8E%E4%B8%8E%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E8%A7%A3%E6%9E%90/">ğŸ“Œ C&#43;&#43;ç±»æˆå‘˜å‡½æ•° static ä¸ const çš„å£°æ˜ä¸å®šä¹‰è§„åˆ™è§£æ</a></li><li><a href="/posts/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-delete-%E4%B8%8E%E7%A7%81%E6%9C%89%E5%8C%96%E6%9E%84%E9%80%A0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%8C%BA%E5%88%AB/">ğŸ“Œæ·±å…¥åˆ†æ =delete ä¸ç§æœ‰åŒ–æ„é€ å’Œææ„å‡½æ•°çš„æœ¬è´¨åŒºåˆ«</a></li><li><a href="/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-c&#43;&#43;-%E4%B8%AD%E7%9A%84-std-ref-%E5%92%8C-cref-%E7%9A%84%E5%BC%95%E7%94%A8%E5%B0%81%E8%A3%85%E6%9C%BA%E5%88%B6/">ğŸ“Œæ·±å…¥ç†è§£ C&#43;&#43; ä¸­çš„ std ref å’Œ cref çš„å¼•ç”¨å°è£…æœºåˆ¶</a></li><li><a href="/posts/asan/">asan</a></li><li><a href="/posts/c&#43;&#43;-%E5%89%8D%E5%90%91%E5%A3%B0%E6%98%8E%E4%B8%8E%E6%8C%87%E9%92%88%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">C&#43;&#43; å‰å‘å£°æ˜ä¸æŒ‡é’ˆä½¿ç”¨æŒ‡å—</a></li></ul></aside></div>
  </div>
</body>
</html>
